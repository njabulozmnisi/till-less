# Story 3.3: Optimisation Results & Explanations UI

## Status
Draft

## Story
**As a** TillLess shopper,
**I want** a results view with savings breakdown, comparisons, and explanations,
**so that** I understand why a store was recommended and can adjust preferences before purchasing.

## Acceptance Criteria
1. Results screen displays recommended store card with total cost, savings %, travel cost assumptions, timestamp, and runner-up summary using optimisation API response. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope][Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
2. Item comparison table shows per-item price, loyalty price, unit price, promo badges, substitution notes across retailers and supports sorting/filtering by price difference. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
3. Explanations and assumptions sections render messages from API (Story 2.3) highlighting savings vs travel trade-offs and missing items in accessible format. [Source: docs/stories/2.3-travel-costs-explanations.md]
4. Users can adjust key preferences (toggle loyalty, adjust value-of-time) inline and re-run optimisation without leaving the page. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
5. UI meets responsive layout and accessibility standards (keyboard navigation, ARIA annotations, table semantics) across desktop/mobile. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
6. Jest/React Testing Library covers results card, table sorting, explanation rendering, and re-run workflow; visual regression optional. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] API integration & state (AC: 1, 4)
  - [ ] Implement React Query hook under `apps/web/app/(authenticated)/results/hooks/` to fetch optimisation results, manage loading/error states, and trigger re-run mutations with updated preferences. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Handle stale data by timestamping responses and prompting refresh when older than configured threshold. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
- [ ] Results summary components (AC: 1, 3)
  - [ ] Build recommended store card, runner-up summary, and assumptions list using design system components with travel/savings metrics. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
  - [ ] Display status badges for data freshness and highlight missing items count.
- [ ] Comparison table (AC: 2, 5)
  - [ ] Implement virtualised table (TanStack Table or equivalent) supporting up to 60 items with sticky headers, sorting, filtering, and responsive column collapse on mobile. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
  - [ ] Show promo badges, substitution tags, and price deltas; ensure row focus/keyboard navigation accessible. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
- [ ] Explanations & preference controls (AC: 3, 4)
  - [ ] Render explanation list with icons and CTA to view detailed reasoning; ensure messages <200 chars. [Source: docs/stories/2.3-travel-costs-explanations.md]
  - [ ] Embed loyalty/value-of-time toggles pulling from preferences API and re-run optimisation on change with optimistic UI. [Source: docs/stories/3.2-preferences-loyalty-ui.md]
- [ ] Testing & docs (AC: 6)
  - [ ] Add React Testing Library suites for summary components, table interactions, explanations, and re-run flows; include fixtures for promo/travel scenarios. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Update UI documentation with screenshots, component usage, and testing instructions. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

## Dev Notes
**Dependencies & Context**
- Requires optimisation API enhancements from Stories 2.1â€“2.3 plus preferences endpoints (Story 3.2). Ensure response typing stays in sync via `packages/types/optimisation.ts`. [Source: docs/stories/2.1-optimisation-service-foundation.md][Source: docs/stories/2.2-promo-pricing-engine.md]

**Data Presentation**
- Highlight savings vs baseline, include disclaimers about price variability per PRD. Provide tooltip linking to promo details when available. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- Display missing items with fallback suggestions or note reasons (no match, substitution blocked).

**Performance**
- Virtualise table rows to maintain responsiveness up to 60 items; memoise expensive calculations (price deltas). [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]

**Accessibility**
- Use semantic table markup, `aria-sort` attributes, focus outlines on rows, and accessible descriptions for explanation icons.

**Offline/Error States**
- Provide offline banner with cached results and ability to retry when connection restored.

### Testing
- Unit/component tests: results card metrics, table sorting/filtering, explanation rendering, preference toggles. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: mock optimisation API to validate re-run workflow and data refresh messaging.
- Manual QA: record walkthrough across breakpoints, verify accessibility (axe, keyboard), confirm re-run updates results.
- Key scenarios: no promos vs heavy promos, high travel cost causing recommendation swap, toggling loyalty card, API failure fallback, missing items explanation.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
