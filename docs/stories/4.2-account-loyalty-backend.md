# Story 4.2: Account Profile & Loyalty Backend

- **Status:** Draft
- **Epic:** 4 â€“ Account & Auth Enablement
- **Related PRD Sections:** `docs/prd/07-7-detailed-requirements.md`
- **Related Architecture Sections:** `docs/architecture/04-4-component-breakdown.md`

## Story Statement
Implement backend endpoints for storing user profiles, loyalty cards, and preferences to support frontend experiences and optimisation constraints.

## Acceptance Criteria
- [ ] Prisma models for `UserProfile`, `LoyaltyCard`, and preference settings created with migrations.
- [ ] NestJS endpoints (`GET/PUT /profile`, `GET/PUT /preferences`) secured via BetterAuth guard.
- [ ] Data validation ensures loyalty card numbers hashed/encrypted at rest.
- [ ] Preferences include max stores, max distance, value-of-time, substitution defaults.
- [ ] Unit tests cover service logic and data transformations.

## Tasks & Subtasks
1. **Schema & Migration**
   - Define Prisma models; run migrations on dev/staging.
2. **Service Implementation**
   - Build profile service for CRUD operations; integrate encryption utilities.
3. **Controllers & DTOs**
   - Create REST endpoints with validation and transformation.
4. **Integration with Frontend**
   - Provide API contracts for Story 3.2; document in Swagger.
5. **Testing**
   - Jest tests for services/controllers; add e2e tests with Supertest.

## Dependencies
- Story 4.1 (BetterAuth) completed.

## QA Checklist
- [ ] Swagger docs updated with profile routes.
- [ ] Evidence of encrypted loyalty data in database.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
