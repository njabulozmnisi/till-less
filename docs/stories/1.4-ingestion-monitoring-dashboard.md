# Story 1.4: Ingestion Monitoring & Alerting Dashboard

## Status
Draft

## Story
**As a** TillLess operations lead,
**I want** an ingestion monitoring dashboard with proactive alerting for retailer workflows,
**so that** the team can react quickly to data freshness issues and maintain trust in optimisation outputs.

## Acceptance Criteria
1. Instrumented ingestion workflows emit run metadata (retailer, schedule, duration, SKU count, promo counts, success/failure, last scrape timestamp) into the shared monitoring store. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting][Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
2. A dashboard (Metabase or Grafana) visualises per-retailer status including recent run timeline, SKU count trends, promo coverage, and failure history. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
3. Alerting pipeline notifies Slack (or configured channel) on conditions: two consecutive workflow failures, data freshness >4 hours, SKU count drop >30% compared to trailing average. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting][Source: docs/ops/temporalite-runbook.md#alerting-hooks]
4. Runbook documentation updated with dashboard URLs, alert severity definitions, and remediation playbooks. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
5. QA evidence includes dashboard screenshot/export and captured alert test demonstrating the notification payload with remediation instructions. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Instrument ingestion workflows and persistence layer (AC: 1)
  - [ ] Extend Temporal activities within `apps/temporal-orchestrator/` to emit run metrics (duration, SKU count, promo totals) via OpenTelemetry or direct Prisma inserts. [Source: docs/architecture/source-tree.md#source-tree--module-layout][Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
  - [ ] Add Prisma model or metrics table under `packages/data-access/` to store per-run records accessible to dashboards. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- [ ] Build monitoring dashboard (AC: 2)
  - [ ] Create Metabase questions or Grafana panels within `apps/ingestion-dashboard/` highlighting latest run status, SKU/promo trends, and failure counts per retailer. [Source: docs/architecture/source-tree.md#source-tree--module-layout][Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
  - [ ] Publish dashboard URL and ensure access controls align with operations needs (read-only links for on-call). [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
- [ ] Implement alerting rules (AC: 3)
  - [ ] Configure Temporal schedule hooks or GitHub Actions workflow to query run metrics and detect failure/freshness/SKU drop thresholds, sending Slack webhook notifications. [Source: docs/ops/temporalite-runbook.md#alerting-hooks]
  - [ ] Embed remediation guidance and escalation steps in the notification payload. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
- [ ] Update runbook & documentation (AC: 4)
  - [ ] Revise `docs/ops/temporalite-runbook.md` with dashboard links, alert definitions, and troubleshooting procedures. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
  - [ ] Document on-call rotation expectations and data validation queries for verifying recoveries. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
- [ ] Validate monitoring & alerting (AC: 5)
  - [ ] Simulate failures/stale data (e.g., disable worker) to trigger alerts and capture logs/screenshots. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Verify dashboard updates after successful run and attach evidence to story QA checklist. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Dev Notes
**Previous Story Insights**
- Stories 1.1â€“1.3 established ingestion workers, Temporal schedules, and shared observability hooks; this story consumes their metrics and extends operational visibility. [Source: docs/stories/1.1.data-backbone-bootstrap.md][Source: docs/stories/1.2.shoprite-pnp-ingestion.md][Source: docs/stories/1.3-woolworths-makro-foodlovers.md]

**Monitoring Architecture**
- Observability strategy requires tracking ingestion job completion, queue depth, SKU counts, promos, and failure alerts; leverage existing logging and OpenTelemetry pipelines. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
- Temporalite runbook already references alert hooks; extend to cover new metrics and Slack payload expectations. [Source: docs/ops/temporalite-runbook.md#alerting-hooks]

**Data & Storage**
- Store metrics in Supabase Postgres tables managed by Prisma to stay within existing infrastructure; ensure retention policy aligns with dashboard needs. [Source: docs/architecture/04-4-component-breakdown.md#43-canonical-product-registry-cpr]
- Reuse `packages/data-access/` for metric model definitions to avoid scattering persistence logic. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

**Project Structure**
- Dashboard code (if custom) belongs under `apps/ingestion-dashboard/`; CLI scripts or automation should live under `scripts/temporal/` or GitHub Actions workflows. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

**Security & Access**
- Store Slack/webhook secrets in secrets manager; avoid logging payloads containing tokens. [Source: docs/retailer-scraping-playbook.md#1-shared-principles]
- Grant read-only dashboard access to on-call engineers; document credentials rotation process in runbook. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]

### Testing
- Unit tests: metric persistence utilities and alert threshold evaluators should have Jest coverage. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: simulate workflow completion to confirm metrics ingestion and alert evaluation logic using Temporal test harness. [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
- Manual QA: trigger alert scenarios, capture dashboard screenshots, verify remediation steps documented.
- Key scenarios: missing workflow run triggers alert, SKU drop detection, dashboard reflects recovery, runbook instructions followed without ambiguity.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
