# Story 1.4: Ingestion Monitoring & Alerting Dashboard

- **Status:** Draft
- **Epic:** 1 – Data Backbone Foundations
- **Related PRD Sections:** `docs/prd/06-6-assumptions-dependencies.md`, `docs/prd/07-7-detailed-requirements.md`
- **Related Architecture Sections:** `docs/architecture/04-4-component-breakdown.md`, `docs/architecture/06-6-technology-stack.md`, `docs/architecture/09-9-monitoring-alerting.md`, `docs/ops/temporalite-runbook.md`

## Story Statement
To maintain trust in TillLess data, we require a monitoring dashboard and alerting pipeline that visualises ingestion health (per retailer) and notifies the team when Temporalite workflows fail or data freshness degrades.

## Acceptance Criteria
- [ ] Metrics pipeline captures ingestion run metadata (retailer, schedule, duration, SKU count, success/failure, last scrape time) and persists to monitoring store (e.g., Supabase metrics table or Prometheus).
- [ ] Dashboard (Metabase/Grafana) displays per-retailer status including latest run timestamp, SKU counts trend, promo counts, and failure history.
- [ ] Alerting configured (Slack/email) for conditions: two consecutive workflow failures, stale data (>4h without successful run), or SKU count drop >30% vs trailing average.
- [ ] Temporalite runbook updated with dashboard URLs and alert handling instructions.
- [ ] QA evidence includes screenshots of dashboard and simulated failure alert.

## Tasks & Subtasks
1. **Define Metrics Schema**
   - Extend Postgres (or Prometheus config) to store workflow run logs with key fields.
   - Update NestJS/Temporal workflows to emit metrics (using OpenTelemetry or direct inserts).
2. **Dashboard Implementation**
   - Set up Metabase questions or Grafana panels for per-retailer metrics.
   - Visualise trends (SKU count, promos) and highlight last successful run.
3. **Alerting Pipeline**
   - Implement GitHub Actions or Temporal hooks to evaluate failure/stale conditions.
   - Send Slack/webhook notifications with remediation steps.
4. **Documentation & Runbook**
   - Update `docs/ops/temporalite-runbook.md` with dashboard access, alert meanings, on-call steps.
   - Add troubleshooting section for common ingestion issues.
5. **Testing**
   - Simulate failure (disable worker) and verify alert triggered.
   - Validate dashboard updates after successful run.

## Implementation Notes
- Prefer storing metrics in Postgres to avoid additional infra; consider using Prisma models.
- Reuse existing logging middleware; integrate with OpenTelemetry where feasible.
- For free-tier Grafana Cloud, ensure metric volume remains within limits.

## Dependencies
- Stories 1.1–1.3 in place to provide data feeds.
- Access to Slack/webhook channel for alerts.

## QA Checklist
- [ ] Dashboard screenshot or exported report attached.
- [ ] Alert test evidence (log + received notification) attached.
- [ ] Runbook updated reference confirmed.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
