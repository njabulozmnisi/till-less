# Story 1.5: CI/CD Pipeline & Deployment Setup

**GitHub Issue:** #20
**Issue URL:** https://github.com/njabulozmnisi/till-less/issues/20
**Epic:** Sprint 1 - Foundation & Authentication Infrastructure
**Status:** Ready for QA
**Estimate:** M (Medium) - 1-2 days
**Story Points:** 5
**Assigned To:** Developer (James)

---

## Context

Establish automated CI/CD pipeline with GitHub Actions to deploy the TillLess application to production environments. This completes Epic 1 (Foundation & Authentication Infrastructure) by enabling continuous deployment, automated testing, and production monitoring.

Currently, the monorepo has working web (Next.js) and API (NestJS) applications with authentication (Stories 1.1-1.4 complete), but no automated deployment or health monitoring. Manual deployments are error-prone and slow iteration.

**Dependencies:**
- ✅ Story 1.1 (Nx Monorepo Setup) - Build system ready
- ✅ Story 1.2 (Tailwind CSS v4 + Shadcn UI) - Frontend builds
- ✅ Story 1.3 (Supabase + Prisma) - Database migrations exist
- ✅ Story 1.4 (User Authentication) - API endpoints ready

---

## Goals

- Automate frontend deployment to Vercel on push to `main`
- Automate backend API deployment to Railway on push to `main`
- Run automated tests in CI before deployment
- Apply database migrations automatically on API deployment
- Add health check endpoints for monitoring
- Integrate Sentry for error tracking and monitoring
- Document deployment process for team

---

## Non-Goals

- Advanced deployment strategies (blue-green, canary) - defer to v2
- Multi-environment setup (staging, QA) - start with production only
- Performance monitoring/APM - defer to Epic 8
- Load testing infrastructure - defer to future
- Custom domain setup - defer to post-MVP
- CDN configuration - Vercel handles this automatically

---

## Acceptance Criteria

1. **AC1: GitHub Actions CI Pipeline**
   - Given a PR or push to `main`, When the CI workflow runs, Then linting, type-checking, and tests execute successfully

2. **AC2: Automated Frontend Deployment**
   - Given a push to `main` branch, When the deployment workflow runs, Then the Next.js web app deploys to Vercel automatically

3. **AC3: Automated Backend Deployment**
   - Given a push to `main` branch, When the deployment workflow runs, Then the NestJS API deploys to Railway automatically

4. **AC4: Database Migration on Deployment**
   - Given a new API deployment with schema changes, When the Railway build runs, Then Prisma migrations apply automatically before app starts

5. **AC5: Health Check Endpoints**
   - Given the API is running, When `/health` endpoint is called, Then it returns 200 OK with database connection status

6. **AC6: Sentry Error Monitoring**
   - Given an error occurs in production (web or API), When the error is thrown, Then it's captured in Sentry with context

7. **AC7: Environment Variables Management**
   - Given production deployments, When apps start, Then all required environment variables are configured securely (Vercel/Railway dashboards)

---

## Tasks / Subtasks

### Setup & Configuration Tasks

- [ ] **Task 1: Create Vercel Account & Project** (AC: 2)
  - Sign up for Vercel free tier account
  - Create new Vercel project
  - Connect GitHub repository to Vercel
  - Configure root directory: `apps/web`
  - Set build command: `pnpm nx build web`
  - Set output directory: `dist/apps/web/.next`

- [ ] **Task 2: Create Railway Account & Project** (AC: 3)
  - Sign up for Railway free tier account
  - Create new Railway project for API
  - Connect GitHub repository to Railway
  - Configure root directory: `apps/api`
  - Set build command: `pnpm nx build api`
  - Set start command: `node dist/apps/api/main.js`

- [ ] **Task 3: Create Sentry Account & Projects** (AC: 6)
  - Sign up for Sentry free tier account
  - Create Sentry project for Next.js app
  - Create Sentry project for NestJS API
  - Get DSN keys for both projects
  - Configure sample rate: 10% for MVP

### GitHub Actions Workflows

- [ ] **Task 4: Create CI Workflow** (AC: 1)
  - Create `.github/workflows/ci.yml`
  - Configure triggers: PR, push to `main`, push to `develop`
  - Add pnpm setup with caching
  - Add lint step: `pnpm nx run-many --target=lint --all`
  - Add type-check step: `pnpm nx run-many --target=type-check --all`
  - Add test step: `pnpm nx run-many --target=test --all`
  - Add build step: `pnpm nx run-many --target=build --all`

- [ ] **Task 5: Add GitHub Secrets** (AC: 2, 3, 6)
  - Add `VERCEL_TOKEN` to GitHub repository secrets
  - Add `RAILWAY_TOKEN` to GitHub repository secrets
  - Add `SENTRY_AUTH_TOKEN` to GitHub repository secrets
  - Document secret generation in README.md

- [ ] **Task 6: Create Deploy Workflow (Optional)** (AC: 2, 3)
  - Vercel/Railway auto-deploy on push to `main` (no workflow needed)
  - OR create `.github/workflows/deploy.yml` for manual control
  - Add deploy steps for web (Vercel CLI)
  - Add deploy steps for API (Railway CLI)

### Backend Health Check

- [ ] **Task 7: Create Health Module in NestJS** (AC: 5)
  - Create `apps/api/src/health/health.module.ts`
  - Create `apps/api/src/health/health.controller.ts`
  - Install `@nestjs/terminus` package
  - Import HealthModule in AppModule

- [ ] **Task 8: Implement Health Check Endpoint** (AC: 5)
  - Create `GET /health` endpoint
  - Add Prisma health indicator (database connection check)
  - Return JSON: `{ status, database, uptime, timestamp }`
  - Add memory/disk health checks (optional)

### Sentry Integration - Backend

- [ ] **Task 9: Install Sentry in NestJS** (AC: 6)
  - Install `@sentry/nestjs` package
  - Create `apps/api/src/sentry/sentry.module.ts`
  - Configure Sentry with DSN from environment
  - Set sample rate: 0.1 (10%)

- [ ] **Task 10: Add Sentry Global Exception Filter** (AC: 6)
  - Create `apps/api/src/sentry/sentry.filter.ts`
  - Extend BaseExceptionFilter
  - Capture exceptions to Sentry
  - Register filter globally in main.ts

### Sentry Integration - Frontend

- [ ] **Task 11: Install Sentry in Next.js** (AC: 6)
  - Install `@sentry/nextjs` package
  - Run Sentry wizard: `npx @sentry/wizard@latest -i nextjs`
  - Configure `sentry.client.config.ts`
  - Configure `sentry.server.config.ts`
  - Configure `sentry.edge.config.ts`

- [ ] **Task 12: Add Sentry Error Boundary** (AC: 6)
  - Create custom Error Boundary component
  - Wrap app with Error Boundary in `app/layout.tsx`
  - Add fallback UI for errors
  - Log errors to Sentry with context

### Environment Variables Setup

- [ ] **Task 13: Configure Vercel Environment Variables** (AC: 7)
  - Add `NEXT_PUBLIC_AUTH_URL` (Railway API URL)
  - Add `NEXT_PUBLIC_SENTRY_DSN` (Sentry web project DSN)
  - Add `SENTRY_AUTH_TOKEN` (for source maps upload)
  - Verify variables in Vercel dashboard

- [ ] **Task 14: Configure Railway Environment Variables** (AC: 7)
  - Add `DATABASE_URL` (Supabase connection string)
  - Add `BETTER_AUTH_SECRET` (32-char JWT secret)
  - Add `BETTER_AUTH_URL` (production callback URL)
  - Add `SENTRY_DSN` (Sentry API project DSN)
  - Add `NODE_ENV=production`
  - Verify variables in Railway dashboard

### Database Migration Setup

- [ ] **Task 15: Configure Railway Build Command** (AC: 4)
  - Update Railway start command: `npx prisma migrate deploy && node dist/apps/api/main.js`
  - Test migration runs before app starts
  - Add migration rollback documentation
  - Verify migrations apply on first deployment

### Testing & Documentation

- [ ] **Task 16: Test CI Pipeline** (AC: 1)
  - Open test PR and verify CI runs
  - Check lint, type-check, test, build all pass
  - Fix any CI failures
  - Verify caching works (faster subsequent runs)

- [ ] **Task 17: Test Deployments** (AC: 2, 3)
  - Push to `main` and verify Vercel deploys
  - Push to `main` and verify Railway deploys
  - Check Vercel deployment URL returns working app
  - Check Railway deployment URL `/health` returns 200

- [ ] **Task 18: Test Sentry Integration** (AC: 6)
  - Trigger test error in web app (button click)
  - Trigger test error in API (test endpoint)
  - Verify errors appear in Sentry dashboard
  - Check source maps uploaded correctly

- [ ] **Task 19: Update Documentation** (AC: All)
  - Add "Deployment" section to README.md
  - Document environment variables setup
  - Document CI/CD workflow
  - Document health check endpoint
  - Add troubleshooting guide for common deployment issues

---

## Dev Notes & Implementation Details

### Tech Stack Decisions

- **CI/CD:** GitHub Actions (free for public repos, 2000 min/month for private)
- **Frontend Hosting:** Vercel (100GB bandwidth/month free, auto-scaling)
- **Backend Hosting:** Railway ($5 credit/month free, ~550 hours uptime)
- **Error Monitoring:** Sentry (5k errors/month free, 10% sample rate)
- **Database:** Supabase PostgreSQL (existing from Story 1.3)

### GitHub Actions CI Workflow

**File:** `.github/workflows/ci.yml`

```yaml
name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint all projects
        run: pnpm nx run-many --target=lint --all

      - name: Type-check all projects
        run: pnpm nx run-many --target=type-check --all

      - name: Test all projects
        run: pnpm nx run-many --target=test --all

      - name: Build all projects
        run: pnpm nx run-many --target=build --all
```

### Vercel Configuration

**Auto-Deploy Settings:**
- **Framework:** Next.js
- **Root Directory:** `apps/web`
- **Build Command:** `pnpm nx build web`
- **Output Directory:** `dist/apps/web/.next`
- **Install Command:** `pnpm install`
- **Node Version:** 20

**Environment Variables:**
```env
NEXT_PUBLIC_AUTH_URL=https://your-api.railway.app/api/auth
NEXT_PUBLIC_SENTRY_DSN=https://xxxxx@o1234567.ingest.sentry.io/1234567
SENTRY_AUTH_TOKEN=sntrys_xxxxxxxxxxxxx
```

### Railway Configuration

**Auto-Deploy Settings:**
- **Root Directory:** `apps/api`
- **Build Command:** `pnpm nx build api`
- **Start Command:** `npx prisma migrate deploy && node dist/apps/api/main.js`
- **Healthcheck Path:** `/health`
- **Restart Policy:** Always

**Environment Variables:**
```env
DATABASE_URL=postgresql://postgres:password@aws-0-eu-west-1.pooler.supabase.com:5432/postgres
BETTER_AUTH_SECRET=your-32-char-secret-here
BETTER_AUTH_URL=https://your-api.railway.app/api/auth
SENTRY_DSN=https://xxxxx@o1234567.ingest.sentry.io/7654321
NODE_ENV=production
PORT=3001
```

### Health Check Endpoint

**File:** `apps/api/src/health/health.controller.ts`

```typescript
import { Controller, Get } from '@nestjs/common';
import { HealthCheck, HealthCheckService, PrismaHealthIndicator } from '@nestjs/terminus';
import { PrismaService } from '@tillless/database';

@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private prismaHealth: PrismaHealthIndicator,
    private prisma: PrismaService,
  ) {}

  @Get()
  @HealthCheck()
  async check() {
    return this.health.check([
      () => this.prismaHealth.pingCheck('database', this.prisma),
    ]);
  }
}
```

**Expected Response:**
```json
{
  "status": "ok",
  "info": {
    "database": {
      "status": "up"
    }
  },
  "error": {},
  "details": {
    "database": {
      "status": "up"
    }
  }
}
```

### Sentry Configuration

**Backend:** `apps/api/src/main.ts`

```typescript
import * as Sentry from '@sentry/nestjs';

if (process.env.SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || 'development',
    tracesSampleRate: 0.1, // 10% of transactions
  });
}

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  // ... rest of setup
}
```

**Frontend:** `apps/web/sentry.client.config.ts`

```typescript
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
});
```

### Migration Strategy

**Railway Automatic Migrations:**

Railway runs migrations before starting the app using this start command:
```bash
npx prisma migrate deploy && node dist/apps/api/main.js
```

**Migration Steps:**
1. Railway pulls latest code from `main` branch
2. Runs `pnpm install` to install dependencies
3. Runs `pnpm nx build api` to build the application
4. Runs `npx prisma migrate deploy` to apply pending migrations
5. If migrations succeed, starts app with `node dist/apps/api/main.js`
6. If migrations fail, deployment stops and app keeps running previous version

**Rollback Plan:**
- Revert git commit with breaking migration
- Push to `main` to trigger new deployment
- Manually run `prisma migrate resolve --rolled-back <migration-name>` if needed

### Environment Variables Checklist

**Vercel (Frontend):**
- [ ] `NEXT_PUBLIC_AUTH_URL` - API base URL (e.g., `https://api.tillless.com`)
- [ ] `NEXT_PUBLIC_SENTRY_DSN` - Sentry web project DSN
- [ ] `SENTRY_AUTH_TOKEN` - For source map uploads (build-time only)

**Railway (Backend):**
- [ ] `DATABASE_URL` - Supabase PostgreSQL connection string
- [ ] `BETTER_AUTH_SECRET` - 32-character JWT secret (generate: `openssl rand -base64 32`)
- [ ] `BETTER_AUTH_URL` - Auth callback URL (e.g., `https://api.tillless.com/api/auth`)
- [ ] `SENTRY_DSN` - Sentry API project DSN
- [ ] `NODE_ENV=production` - Set Node environment
- [ ] `PORT=3001` - API port (optional, Railway auto-assigns)

### Testing Strategy

**CI Pipeline Testing:**
1. Create test PR with failing lint → Verify CI catches error
2. Fix lint and push → Verify CI passes
3. Merge PR → Verify deployments triggered

**Deployment Testing:**
1. Push to `main` with small change
2. Monitor Vercel deployment logs
3. Monitor Railway deployment logs
4. Check Vercel URL returns working app
5. Check Railway `/health` endpoint returns 200
6. Verify database migrations applied (check Railway logs)

**Sentry Testing:**
1. Add test error button in web app: `<button onClick={() => { throw new Error('Test Sentry') }}>Test Error</button>`
2. Click button and verify error in Sentry dashboard
3. Add test endpoint in API: `@Get('test-error') testError() { throw new Error('Test Sentry API'); }`
4. Call endpoint and verify error in Sentry dashboard
5. Remove test code after verification

**Health Check Testing:**
```bash
# Production health check
curl https://your-api.railway.app/health

# Expected response
{
  "status": "ok",
  "info": { "database": { "status": "up" } },
  "error": {},
  "details": { "database": { "status": "up" } }
}
```

### Performance Considerations

**Vercel:**
- Edge caching enabled by default
- Automatic image optimization
- ISR (Incremental Static Regeneration) for dynamic pages
- Global CDN (low latency worldwide)

**Railway:**
- Cold start time: ~2-5 seconds (acceptable for MVP)
- Can enable "always on" to prevent cold starts ($5/month)
- Auto-scaling not available on free tier
- Health checks every 30 seconds

**CI Pipeline:**
- Nx caching reduces build time by 50-80%
- Parallel task execution with `run-many`
- pnpm caching for dependencies (~30s install time)

### Security Considerations

- ✅ Never commit secrets to repository
- ✅ Use GitHub encrypted secrets for CI/CD tokens
- ✅ Rotate secrets regularly (quarterly)
- ✅ Use environment-specific secrets (dev, prod)
- ✅ Enable Vercel/Railway IP allowlisting (post-MVP)
- ✅ Set Sentry sample rate to 10% (avoid quota exhaustion)

### Cost Breakdown (Free Tier Limits)

**Vercel Free Tier:**
- 100GB bandwidth/month
- Unlimited deployments
- 100 GB-hours of function execution
- **Estimated usage:** ~10GB/month (MVP with 500 users)

**Railway Free Tier:**
- $5 credit/month (~550 hours of 1GB RAM instance)
- No credit card required
- Sleeps after 10 min inactivity (free tier)
- **Estimated usage:** ~$3/month (MVP with light traffic)

**Sentry Free Tier:**
- 5,000 errors/month
- 10,000 transactions/month
- 1 project member
- **Estimated usage:** ~500 errors/month (10% sample rate)

**GitHub Actions Free Tier:**
- 2,000 minutes/month (private repos)
- Unlimited for public repos
- **Estimated usage:** ~200 minutes/month (4 runs/day @ 10 min each)

**Total Monthly Cost: $0** (all within free tiers)

### Troubleshooting Guide

**Issue: CI pipeline fails on lint**
- Run `pnpm nx run-many --target=lint --all` locally
- Fix linting errors
- Commit and push

**Issue: Vercel build fails**
- Check Vercel deployment logs
- Verify environment variables set
- Check `nx build web` runs locally
- Ensure correct Node version (20)

**Issue: Railway build fails**
- Check Railway deployment logs
- Verify Prisma migrations exist
- Check `nx build api` runs locally
- Verify `DATABASE_URL` is set

**Issue: Migrations fail on Railway**
- Check migration files in `libs/database/prisma/migrations`
- Run `npx prisma migrate deploy` locally
- Check Railway logs for specific error
- Rollback migration if needed

**Issue: Health check returns 500**
- Check Railway logs for errors
- Verify `DATABASE_URL` is correct
- Test database connection locally
- Check Prisma service is injected

**Issue: Sentry not capturing errors**
- Verify `SENTRY_DSN` environment variable set
- Check Sentry project DSN is correct
- Verify sample rate > 0
- Check network tab for Sentry requests

---

## Risks & Mitigations

- **Risk: Railway cold starts** → Mitigation: Use Railway's "always on" setting for API ($5/month)
- **Risk: Migration failures break deployment** → Mitigation: Test migrations locally first, add rollback docs
- **Risk: Secret exposure in CI logs** → Mitigation: Use GitHub encrypted secrets, never log secrets
- **Risk: Deployment downtime** → Mitigation: Vercel/Railway handle zero-downtime deploys automatically
- **Risk: High Sentry quota usage** → Mitigation: Use free tier with sample rate 10% for MVP
- **Risk: Railway credit exhaustion** → Mitigation: Monitor usage, upgrade to hobby plan ($5/month) if needed

---

## Definition of Done

- [ ] All 19 tasks completed and tested
- [ ] All 7 acceptance criteria verified
- [ ] CI pipeline running on every PR and push
- [ ] Vercel auto-deploys on push to `main`
- [ ] Railway auto-deploys on push to `main`
- [ ] Database migrations run automatically on deployment
- [ ] Health check endpoint returns 200 in production
- [ ] Sentry captures errors in production (web + API)
- [ ] All environment variables configured in Vercel/Railway
- [ ] Documentation updated (README.md deployment section)
- [ ] Manual deployment testing successful
- [ ] Code reviewed and merged to `develop`
- [ ] Story 1.5 marked as complete in GitHub Issue #20

---

## Links & References

- **GitHub Issue:** https://github.com/njabulozmnisi/till-less/issues/20
- **Vercel Deployment Docs:** https://vercel.com/docs
- **Railway Deployment Docs:** https://docs.railway.app
- **GitHub Actions Docs:** https://docs.github.com/actions
- **Nx CI/CD Guide:** https://nx.dev/ci/intro/ci-with-nx
- **Sentry Next.js:** https://docs.sentry.io/platforms/javascript/guides/nextjs/
- **Sentry NestJS:** https://docs.sentry.io/platforms/node/guides/nestjs/
- **Prisma Migrations:** https://www.prisma.io/docs/concepts/components/prisma-migrate

---

**Created:** 2025-12-29
**Last Updated:** 2025-12-29
**Assigned To:** Developer (James)
**Reviewer:** Scrum Master (Bob)
