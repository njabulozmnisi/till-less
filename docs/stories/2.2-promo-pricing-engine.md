# Story 2.2: Promotion & Pricing Engine

- **Status:** Draft
- **Epic:** 2 â€“ Optimisation Engine & API
- **Related PRD Sections:** `docs/prd/07-7-detailed-requirements.md`
- **Related Architecture Sections:** `docs/architecture/04-4-component-breakdown.md`, `docs/architecture/05-5-key-data-flows.md`

## Story Statement
Enhance the optimisation service to compute accurate basket totals by applying promotions, loyalty pricing, and substitution logic so TillLess can deliver trustworthy savings estimates.

## Acceptance Criteria
- [ ] Pricing engine applies base price, loyalty price, and promo logic (multibuy, combo, loyalty markdown) per item.
- [ ] Substitution policy respects user tolerances (brand lock, size variance) and flags unmet items.
- [ ] Response includes per-item breakdown (store, price, applied promos, savings vs. baseline) and aggregate totals (basket price, savings pct).
- [ ] Unit prices computed for pack conversions (using `price_mode`, `price_per_uom`, `unit_count`).
- [ ] Automated tests cover promo scenarios, substitution paths, and edge cases (insufficient quantity, promo threshold).

## Tasks & Subtasks
1. **Pricing Utilities**
   - Implement helpers for unit conversion, multibuy calculation, loyalty price selection.
2. **Promotion Engine**
   - Evaluate promo eligibility per item (quantity thresholds) and adjust effective price.
   - Capture promo explanations for response payload.
3. **Substitution & Matching**
   - Evaluate canonical matches against user constraints; select best per retailer.
   - Mark missing items with reason codes.
4. **Response Formatting**
   - Update DTOs/Swagger docs with per-item breakdown and totals.
5. **Testing**
   - Create Jest suites covering combinations (loyalty only, multibuy, combo deals, bulk packs).
   - Integration tests with seeded CPR data to verify totals.

## Implementation Notes
- Use mathjs or custom precision helpers to avoid floating-point drift.
- Provide hooks for future travel cost adjustments (Story 2.3).

## Dependencies
- Story 2.1 service foundation complete.
- CPR data includes promo fields from Epic 1 stories.

## QA Checklist
- [ ] Pricing test matrix results attached.
- [ ] Sample API response demonstrating promos and substitutions.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
