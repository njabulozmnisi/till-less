# Story 1.1: Initialize Nx Monorepo with Core Applications

**GitHub Issue:** #7
**Issue URL:** https://github.com/njabulozmnisi/till-less/issues/7
**Status:** Draft

---

## Story Statement

As a **developer**,
I want **an Nx monorepo with Next.js (web), NestJS (api), and shared packages configured**,
so that **I can develop web and backend applications with shared code and optimized build workflows**.

---

## Acceptance Criteria

1. Given the project requirements, when I run `npx create-nx-workspace@latest tillless`, then an Nx workspace is created with pnpm.
2. Given the Nx workspace, when I run `nx g @nx/next:app web`, then a Next.js 15 application is created with App Router, TypeScript, Tailwind CSS v4.
3. Given the Nx workspace, when I run `nx g @nx/nest:app api`, then a NestJS application is created with TypeScript strict mode.
4. Given the monorepo, when I create shared packages (`ui`, `utils`, `types`), then packages are created with proper TypeScript path aliases.
5. Given the Nx configuration, when I run `nx run-many --target=build --all`, then all apps and packages build successfully.
6. Given the workspace, when I inspect `nx.json`, then task pipeline caching is enabled.
7. Given development, when I run `nx serve web` and `nx serve api` in parallel, then web runs on `localhost:3000` and API on `localhost:4000`.

---

## Dev Notes

### Architecture Context

**Tech Stack** [Source: architecture.md#3-tech-stack]:
- **Monorepo Tool:** Nrwl Nx (explicitly preferred over Turborepo)
- **Frontend:** Next.js 15, TypeScript 5.3, Tailwind CSS 4.0
- **Backend:** NestJS 10, TypeScript strict mode
- **Package Manager:** pnpm

**Repository Structure** [Source: architecture.md#2.3-repository-structure]:
```
tillless/
├── apps/
│   ├── web/                    # Next.js 15 PWA (primary user interface)
│   ├── api/                    # NestJS backend (tRPC + REST)
│   └── mobile/                 # Expo React Native (Phase 1.5 - NOT in this story)
├── packages/
│   ├── ui/                     # Shared Shadcn UI + NativeWind components
│   ├── api-client/             # tRPC client, generated types
│   ├── database/               # Prisma schema, migrations, seed data
│   ├── types/                  # Shared TypeScript types, Zod schemas
│   └── utils/                  # Business logic, formatters, validators
├── libs/
│   ├── optimization-engine/    # Category optimization algorithms
│   ├── retailer-adapters/      # Data acquisition strategies
│   └── auth/                   # Shared auth utilities
├── tools/
│   └── scripts/                # DB seeding, migrations, dev tooling
├── nx.json                     # Nx workspace config
├── package.json                # Root dependencies
└── tsconfig.base.json          # Base TypeScript config with path aliases
```

**For This Story, Create:**
- `apps/web/` - Next.js 15 app
- `apps/api/` - NestJS app
- `packages/ui/` - Shared UI components library
- `packages/utils/` - Shared utility functions
- `packages/types/` - Shared TypeScript types

**DO NOT Create Yet (future stories):**
- `apps/mobile/` - Phase 1.5
- `packages/api-client/` - Story 1.5 (tRPC setup)
- `packages/database/` - Story 1.3 (Prisma setup)
- `libs/*` - Epic 2+

### Technical Requirements

**Next.js Configuration** [Source: architecture.md#1.1]:
- Version: Next.js 15
- Router: App Router (NOT Pages Router)
- TypeScript: Strict mode enabled
- Styling: Tailwind CSS v4 (initial setup, detailed config in Story 1.2)

**NestJS Configuration** [Source: architecture.md#1.1]:
- Version: NestJS 10
- TypeScript: Strict mode enabled
- Module Structure: DDD bounded contexts (detailed setup in Epic 2+)

**Nx Configuration** [Source: architecture.md#2.3]:
- Task Pipeline Caching: Must be enabled in `nx.json`
- Parallel Execution: Support for `nx run-many`
- Development Servers: web on port 3000, api on port 4000

### File Locations

**Root Files:**
- `/nx.json` - Nx workspace configuration
- `/package.json` - Root package.json with workspace dependencies
- `/tsconfig.base.json` - Base TypeScript configuration with path aliases
- `/pnpm-workspace.yaml` - pnpm workspace configuration (auto-generated by Nx)

**Application Files:**
- `/apps/web/` - Next.js application root
- `/apps/api/` - NestJS application root

**Shared Package Files:**
- `/packages/ui/` - UI component library
- `/packages/utils/` - Utility functions library
- `/packages/types/` - TypeScript types library

### Testing Requirements

[Source: architecture.md#16-testing-strategy]
- No automated tests required for this infrastructure story
- Manual verification of build and serve commands
- Future stories will add Vitest unit tests and Playwright E2E tests

### Technical Constraints

**Version Requirements:**
- Node.js: 20+
- pnpm: 8+
- Nx: 17+ (latest stable)
- Next.js: 15.x
- NestJS: 10.x
- TypeScript: 5.3+

**Performance Requirements:**
- Build time: All apps should build in <2 minutes initially
- Nx caching: Subsequent builds should leverage cache for unchanged code

---

## Tasks / Subtasks

### Task 1: Initialize Nx Workspace (AC: 1)
1.1. Run `npx create-nx-workspace@latest tillless` with options:
   - Package manager: pnpm
   - Nx Cloud: Skip for now (can enable later)
1.2. Verify workspace creation:
   - Check `nx.json` exists
   - Check `package.json` has Nx dependencies
   - Check `pnpm-workspace.yaml` exists

### Task 2: Generate Next.js Application (AC: 2)
2.1. Install Nx Next.js plugin: `pnpm add -D @nx/next`
2.2. Generate Next.js app: `nx g @nx/next:app web`
   - Options: App Router, TypeScript, Tailwind CSS
2.3. Verify Next.js app structure:
   - Check `apps/web/app/` directory exists (App Router)
   - Check `apps/web/tailwind.config.ts` exists
   - Check TypeScript is configured

### Task 3: Generate NestJS Application (AC: 3)
3.1. Install Nx NestJS plugin: `pnpm add -D @nx/nest`
3.2. Generate NestJS app: `nx g @nx/nest:app api`
   - Options: TypeScript strict mode
3.3. Verify NestJS app structure:
   - Check `apps/api/src/main.ts` exists
   - Check `apps/api/tsconfig.json` has `strict: true`
   - Check default AppModule and AppController exist

### Task 4: Create Shared Packages (AC: 4)
4.1. Generate `ui` package: `nx g @nx/js:library ui --directory=packages/ui --unitTestRunner=none`
4.2. Generate `utils` package: `nx g @nx/js:library utils --directory=packages/utils --unitTestRunner=none`
4.3. Generate `types` package: `nx g @nx/js:library types --directory=packages/types --unitTestRunner=none`
4.4. Verify TypeScript path aliases in `tsconfig.base.json`:
   - `@tillless/ui`
   - `@tillless/utils`
   - `@tillless/types`

### Task 5: Verify Build Configuration (AC: 5)
5.1. Run `nx run-many --target=build --all`
5.2. Verify all apps and packages build without errors
5.3. Check Nx cache directory `.nx/cache` is created

### Task 6: Verify Nx Caching (AC: 6)
6.1. Inspect `nx.json` for `tasksRunnerOptions.default.options.cacheableOperations`
6.2. Verify `build`, `lint`, `test` are in cacheableOperations array
6.3. Run build twice and confirm second build uses cache (check output for "cache hit")

### Task 7: Configure and Test Development Servers (AC: 7)
7.1. Update `apps/web/project.json` to ensure serve target uses port 3000
7.2. Update `apps/api/project.json` to ensure serve target uses port 4000
7.3. Run `nx serve web` and verify http://localhost:3000 loads
7.4. Run `nx serve api` and verify http://localhost:4000 loads (NestJS default endpoint)
7.5. Test parallel execution: `nx run-many --target=serve --projects=web,api --parallel=2`

### Task 8: Create Initial Commit
8.1. Review all generated files
8.2. Create commit with message: `feat(1): initialize Nx monorepo with web and api apps`
   - Include: Nx workspace, Next.js app, NestJS app, shared packages
8.3. Ensure `.gitignore` includes: `node_modules`, `.nx`, `dist`, `.env*`

---

## Project Structure Notes

This story establishes the foundation structure defined in [Architecture Section 2.3]. Future stories will populate the apps and packages with actual implementation:
- Story 1.2: Configure Tailwind CSS v4 and Shadcn UI (updates `apps/web` and `packages/ui`)
- Story 1.3: Set up Prisma and Supabase (creates `packages/database`)
- Story 1.5: Configure tRPC (creates `packages/api-client`)

**Important:** Do NOT create placeholder files in libs/ directory yet - these will be created in Epic 2+ when implementing specific bounded contexts.

---

**Note:** This is a local reference file for development.
[GitHub Issue #7](https://github.com/njabulozmnisi/till-less/issues/7) is the authoritative source of truth for workflow tracking and team collaboration.
