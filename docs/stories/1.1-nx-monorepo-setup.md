# Story 1.1: Initialize Nx Monorepo with Core Applications

**GitHub Issue:** #7
**Issue URL:** https://github.com/njabulozmnisi/till-less/issues/7
**Status:** ✅ Implemented (with modifications - see Actual Implementation below)

---

## Story Statement

As a **developer**,
I want **an Nx monorepo with Next.js (web), NestJS (api), and shared libraries configured**,
so that **I can develop web and backend applications with shared code and optimized build workflows**.

---

## ✅ Actual Implementation

**What was actually built** (deviates from original plan):

### Apps Created (2)
- ✅ `apps/web/` - Next.js 15 with App Router, TypeScript, Tailwind CSS v4
- ✅ `apps/api/` - NestJS backend with TypeScript strict mode
- ❌ `apps/backend/` - Removed in Issue #12 (was empty placeholder, redundant with apps/api)

### Libs Created (4) - Using `libs/` not `packages/`
- ✅ `libs/database/` - Prisma schema, migrations, client (not originally planned for this story)
- ✅ `libs/scrapers/` - Playwright scraper workers (not originally planned for this story)
- ✅ `libs/ocr/` - OCR processing utilities (not originally planned for this story)
- ✅ `libs/shared/` - Shared types, utils, constants (consolidation of planned ui/utils/types)

### Key Deviations from Original Plan

1. **Used `libs/` folder instead of `packages/`**
   - Reason: Modern Nx best practice (Issue #9)
   - Benefit: Simpler two-tier structure (apps + libs)

2. **Created domain-specific libs based on actual needs**
   - Original plan: Generic `ui`, `utils`, `types` packages
   - Actual: `database`, `scrapers`, `ocr`, `shared` based on real requirements
   - Reason: Avoided premature abstraction, created libs as needed

3. **Did NOT create `apps/admin`** (see Issue #10)
   - Consolidated admin features into `apps/web/app/admin/*` routes
   - Reason: Cost savings (~$20-50/month), simpler architecture

4. **Did NOT create `apps/mobile`**
   - Deferred to Phase 1.5 as originally planned

### TypeScript Path Aliases (Actual)
```json
{
  "@tillless/database": ["libs/database/src/index.ts"],
  "@tillless/scrapers": ["libs/scrapers/src/index.ts"],
  "@tillless/ocr": ["libs/ocr/src/index.ts"],
  "@tillless/shared": ["libs/shared/src/index.ts"],
  "@tillless/shared/types": ["libs/shared/src/types/index.ts"],
  "@tillless/shared/utils": ["libs/shared/src/utils/index.ts"],
  "@tillless/shared/constants": ["libs/shared/src/constants/index.ts"]
}
```

### Nx Projects (Actual - 6 total)
```bash
$ nx show projects
database
scrapers
shared
api
ocr
web
```

---

## Acceptance Criteria (Status)

1. ✅ **DONE** - Given the project requirements, when I run `npx create-nx-workspace@latest tillless`, then an Nx workspace is created with pnpm.
2. ✅ **DONE** - Given the Nx workspace, when I run `nx g @nx/next:app web`, then a Next.js 15 application is created with App Router, TypeScript, Tailwind CSS v4.
3. ✅ **DONE** - Given the Nx workspace, when I run `nx g @nx/nest:app api`, then a NestJS application is created with TypeScript strict mode.
4. ✅ **MODIFIED** - Given the monorepo, when I create shared libraries, then `libs/` are created (not `packages/`) with proper TypeScript path aliases (`@tillless/database`, `@tillless/scrapers`, `@tillless/ocr`, `@tillless/shared`).
5. ✅ **DONE** - Given the Nx configuration, when I run `nx run-many --target=build --all`, then all apps and libs build successfully.
6. ✅ **DONE** - Given the workspace, when I inspect `nx.json`, then task pipeline caching is enabled.
7. ✅ **DONE** - Given development, when I run `nx serve web` and `nx serve api` in parallel, then web runs on `localhost:3000` and API on `localhost:3001`.

---

## Dev Notes

### Architecture Context

**Tech Stack** [Source: architecture.md#3-tech-stack]:
- **Monorepo Tool:** Nrwl Nx (explicitly preferred over Turborepo)
- **Frontend:** Next.js 15, TypeScript 5.3, Tailwind CSS 4.0
- **Backend:** NestJS 10, TypeScript strict mode
- **Package Manager:** pnpm

**Repository Structure (ORIGINAL PLAN - see Actual Implementation above)**:
```
tillless/
├── apps/
│   ├── web/                    # Next.js 15 PWA
│   └── api/                    # NestJS backend (all backend services)
├── libs/                       # ✅ ACTUAL: Used libs/ not packages/
│   ├── database/               # Prisma schema, migrations (created in this story)
│   ├── scrapers/               # Playwright workers (created in this story)
│   ├── ocr/                    # OCR utilities (created in this story)
│   └── shared/                 # Types, utils, constants (created in this story)
├── nx.json                     # Nx workspace config
├── package.json                # Root dependencies
├── pnpm-workspace.yaml         # pnpm workspace config
└── tsconfig.base.json          # TypeScript path aliases
```

**✅ Actually Created in This Story:**
- `apps/web/` - Next.js 15 with App Router, Tailwind CSS v4
- `apps/api/` - NestJS backend (all backend services)
- `libs/database/` - Prisma integration
- `libs/scrapers/` - Playwright scraper workers
- `libs/ocr/` - OCR processing
- `libs/shared/` - Shared code (types, utils, constants)

**❌ NOT Created (deviations from plan):**
- `packages/*` - Used `libs/` instead (Nx best practice)
- `apps/admin/` - Consolidated into `apps/web/app/admin/*` (Issue #10)
- `apps/mobile/` - Deferred to Phase 1.5
- `apps/backend/` - Removed in Issue #12 (was empty, redundant with apps/api)

### Technical Requirements

**Next.js Configuration** [Source: architecture.md#1.1]:
- Version: Next.js 15
- Router: App Router (NOT Pages Router)
- TypeScript: Strict mode enabled
- Styling: Tailwind CSS v4 (initial setup, detailed config in Story 1.2)

**NestJS Configuration** [Source: architecture.md#1.1]:
- Version: NestJS 10
- TypeScript: Strict mode enabled
- Module Structure: DDD bounded contexts (detailed setup in Epic 2+)

**Nx Configuration** [Source: architecture.md#2.3]:
- Task Pipeline Caching: Must be enabled in `nx.json`
- Parallel Execution: Support for `nx run-many`
- Development Servers: web on port 3000, api on port 4000

### File Locations

**Root Files:**
- `/nx.json` - Nx workspace configuration
- `/package.json` - Root package.json with workspace dependencies
- `/tsconfig.base.json` - Base TypeScript configuration with path aliases
- `/pnpm-workspace.yaml` - pnpm workspace configuration (auto-generated by Nx)

**Application Files:**
- `/apps/web/` - Next.js application root
- `/apps/api/` - NestJS application root

**Shared Package Files:**
- `/packages/ui/` - UI component library
- `/packages/utils/` - Utility functions library
- `/packages/types/` - TypeScript types library

### Testing Requirements

[Source: architecture.md#16-testing-strategy]
- No automated tests required for this infrastructure story
- Manual verification of build and serve commands
- Future stories will add Vitest unit tests and Playwright E2E tests

### Technical Constraints

**Version Requirements:**
- Node.js: 20+
- pnpm: 8+
- Nx: 17+ (latest stable)
- Next.js: 15.x
- NestJS: 10.x
- TypeScript: 5.3+

**Performance Requirements:**
- Build time: All apps should build in <2 minutes initially
- Nx caching: Subsequent builds should leverage cache for unchanged code

---

## Tasks / Subtasks

### Task 1: Initialize Nx Workspace (AC: 1) - ✅ DONE
1.1. ✅ Run `npx create-nx-workspace@latest tillless` with options:
   - Package manager: pnpm
   - Nx Cloud: Skip for now (can enable later)
1.2. ✅ Verify workspace creation:
   - Check `nx.json` exists
   - Check `package.json` has Nx dependencies
   - Check `pnpm-workspace.yaml` exists

### Task 2: Generate Next.js Application (AC: 2) - ✅ DONE
2.1. ✅ Install Nx Next.js plugin: `pnpm add -D @nx/next`
2.2. ✅ Generate Next.js app: `nx g @nx/next:app web`
   - Options: App Router, TypeScript, Tailwind CSS v4
2.3. ✅ Verify Next.js app structure:
   - Check `apps/web/app/` directory exists (App Router)
   - Check `apps/web/tailwind.config.ts` exists
   - Check TypeScript is configured
2.4. ✅ Added `/admin` routes (Issue #10 - admin consolidation)

### Task 3: Generate NestJS Application (AC: 3) - ✅ DONE
3.1. ✅ Install Nx NestJS plugin: `pnpm add -D @nx/nest`
3.2. ✅ Generate NestJS app: `nx g @nx/nest:app api`
   - Options: TypeScript strict mode
3.3. ✅ Verify NestJS app structure:
   - Check `apps/api/src/main.ts` exists
   - Check `apps/api/tsconfig.json` has `strict: true`
   - Check default AppModule and AppController exist

### Task 4: Create Shared Libraries (AC: 4) - ✅ MODIFIED
**Original Plan:** Create generic `ui`, `utils`, `types` packages
**Actual Implementation:** Created domain-specific libs based on real needs

4.1. ✅ Generated `database` lib: `nx g @nx/js:library database --directory=libs/database`
4.2. ✅ Generated `scrapers` lib: `nx g @nx/js:library scrapers --directory=libs/scrapers`
4.3. ✅ Generated `ocr` lib: `nx g @nx/js:library ocr --directory=libs/ocr`
4.4. ✅ Generated `shared` lib: `nx g @nx/js:library shared --directory=libs/shared`
4.5. ✅ Verified TypeScript path aliases in `tsconfig.base.json`:
   - `@tillless/database`
   - `@tillless/scrapers`
   - `@tillless/ocr`
   - `@tillless/shared` (+ subpath exports for types, utils, constants)

### Task 5: Verify Build Configuration (AC: 5) - ✅ DONE
5.1. ✅ Run `nx run-many --target=build --all`
5.2. ✅ Verify all apps and libs build without errors
5.3. ✅ Check Nx cache directory `.nx/cache` is created

### Task 6: Verify Nx Caching (AC: 6) - ✅ DONE
6.1. ✅ Inspect `nx.json` for `tasksRunnerOptions.default.options.cacheableOperations`
6.2. ✅ Verify `build`, `lint`, `test` are in cacheableOperations array
6.3. ✅ Run build twice and confirm second build uses cache (check output for "cache hit")

### Task 7: Configure and Test Development Servers (AC: 7) - ✅ DONE
7.1. ✅ Update `apps/web/project.json` to ensure serve target uses port 3000
7.2. ✅ Update `apps/api/project.json` to ensure serve target uses port 3001 (not 4000)
7.3. ✅ Run `nx serve web` and verify http://localhost:3000 loads
7.4. ✅ Run `nx serve api` and verify http://localhost:3001 loads (NestJS default endpoint)
7.5. ✅ Test parallel execution: `nx run-many --target=serve --projects=web,api --parallel=2`

### Task 8: Create Initial Commit - ✅ DONE
8.1. ✅ Review all generated files
8.2. ✅ Create commit with message: `feat(1): initialize Nx monorepo with web and api apps`
   - Include: Nx workspace, Next.js app, NestJS app, shared libs
8.3. ✅ Ensure `.gitignore` includes: `node_modules`, `.nx`, `dist`, `.env*`

---

## Project Structure Notes

✅ **COMPLETED** - This story established the Nx monorepo foundation with modifications:

**Related Stories:**
- Story 1.2: Configure Tailwind CSS v4 and Shadcn UI (✅ Done - Issue #8)
- Story 1.3: Set up Prisma and Supabase (✅ Done - `libs/database` created)
- Story 1.5: Configure tRPC (Pending)

**Related Refactors:**
- Issue #9: Removed `packages/` folder, consolidated to `libs/` only
- Issue #10: Removed `apps/admin`, consolidated into `apps/web/app/admin/*`

---

## ✅ Implementation Summary

**Completed:** October 2025

**Final Structure:**
```
tillless/
├── apps/ (2)
│   ├── web/          # Next.js 15 + Tailwind v4 + Admin routes
│   └── api/          # NestJS backend (all backend services)
├── libs/ (4)
│   ├── database/     # Prisma + Supabase
│   ├── scrapers/     # Playwright workers
│   ├── ocr/          # OCR utilities
│   └── shared/       # Types, utils, constants
└── Total: 6 Nx projects
```

**Note:** `apps/backend/` was initially created as a placeholder but removed in Issue #12 as it was redundant with `apps/api/`.

**Key Achievements:**
- ✅ Nx workspace with pnpm configured
- ✅ Next.js 15 with App Router and Tailwind CSS v4
- ✅ NestJS backend with TypeScript strict mode
- ✅ Nx task caching enabled (build, lint, test)
- ✅ TypeScript path aliases configured
- ✅ Parallel development servers working (web:3000, api:3001)
- ✅ Modern two-tier structure (apps + libs, no packages)
- ✅ Cost-optimized (no separate admin deployment)

---

**Note:** This is a local reference file for development.
[GitHub Issue #7](https://github.com/njabulozmnisi/till-less/issues/7) is the authoritative source of truth for workflow tracking and team collaboration.
