# Story 2.1: Optimisation Service Foundation

- **Status:** Draft
- **Epic:** 2 â€“ Optimisation Engine & API
- **Related PRD Sections:** `docs/prd/07-7-detailed-requirements.md`, `docs/prd/09-9-data-model-integrations.md`
- **Related Architecture Sections:** `docs/architecture/04-4-component-breakdown.md`, `docs/architecture/05-5-key-data-flows.md`

## Story Statement
As the TillLess backend team, we need the NestJS optimisation service skeleton with Prisma integration so that shopping list requests can be validated, hydrate canonical data, and return placeholder responses while we build advanced logic.

## Acceptance Criteria
- [ ] NestJS module scaffolding created (`apps/optimisation`) with controller, service, and DTOs for optimisation requests.
- [ ] Prisma schema extended with necessary models/views to query canonical products, price snapshots, and store metadata.
- [ ] Endpoint accepts shopping list payload (items, quantities, tolerances) with class-validator enforcing required fields.
- [ ] Service queries CPR via Prisma and returns structured response including request echo, item match summary, and stub pricing totals.
- [ ] Unit/integration tests cover request validation and Prisma data fetch using test database.
- [ ] API documented in OpenAPI/Swagger with request/response examples.

## Tasks & Subtasks
1. **Project Setup**
   - Generate NestJS module/controller/service skeleton using CLI.
   - Configure shared TypeScript config and pnpm workspace references.
2. **Prisma Integration**
   - Update `schema.prisma` with views or relations for `retailer_item`, `retailer_item_price`, `store`.
   - Generate Prisma client and ensure migrations run via `prisma migrate dev`.
3. **DTOs & Validation**
   - Define request DTO covering item name, quantity, units, substitution tolerance, priority.
   - Implement validation pipes and error handling consistent with API guidelines.
4. **Baseline Logic**
   - Implement service to fetch canonical matches (exact name/brand) and return placeholder totals (e.g., per-item price = null for now).
   - Structure response to include `items[]`, `matchedProducts[]`, `summary`.
5. **Documentation & Testing**
   - Add Jest tests for controller/service using Prisma test harness.
   - Publish Swagger docs at `/api/docs` and update README with usage instructions.

## Implementation Notes
- Reuse shared types from ingestion stories to align product identifiers.
- Prepare for future enhancements by structuring service in layers (matching, pricing, travel). Use dependency injection for later substitution.
- Ensure response shape leaves room for savings explanations and promo details.

## Testing & Validation
- Jest unit tests for DTO validation and service logic (mock Prisma).
- Integration test hitting local database seeded with sample CPR fixtures.
- Manual verification via Swagger or REST client.

## Dependencies
- Epic 1 stories populating CPR data.
- Database migrations from Story 1.1 must be applied.

## QA Checklist
- [ ] Jest tests passing with coverage report attached.
- [ ] Swagger screenshot or Postman export showing sample response.
- [ ] README/API docs updated.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
