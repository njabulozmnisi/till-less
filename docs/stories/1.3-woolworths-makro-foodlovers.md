# Story 1.3: Woolworths, Makro, and Food Lover's Ingestion

- **Status:** Draft
- **Epic:** 1 – Data Backbone Foundations
- **Related PRD Sections:** `docs/prd/05-5-scope-phase-1-mvp.md`, `docs/prd/07-7-detailed-requirements.md`
- **Related Architecture Sections:** `docs/architecture/04-4-component-breakdown.md`, `docs/architecture/06-6-technology-stack.md`

## Story Statement
We must extend the ingestion backbone to cover Woolworths (WRewards), Makro (bulk/mCard), and Food Lover's Market (produce) using the shared Temporalite + pg-boss + NestJS framework so that TillLess delivers comprehensive pricing data across all priority retailers.

## Acceptance Criteria
- [ ] Woolworths, Makro, and Food Lover's Playwright workers capture retailer-specific nuances (multibuy promos, bulk packs, per-weight pricing) as defined in `docs/retailer-scraping-playbook.md`.
- [ ] Temporalite schedules run each retailer per cadence grid (WRewards sweep 60–90m, Makro bulk 6–12h + promo 90m, Food Lover's produce 2–4h) with GitHub cron backup.
- [ ] pg-boss consumer persists ≥300 SKUs per retailer with accurate loyalty/promo fields, per-weight handling for Food Lover's, and bulk pack mapping for Makro.
- [ ] Validation confirms unit conversions (`price_mode`, `price_per_uom`, `unit_count`) align with canonical schema and bulk packs stored correctly.
- [ ] Metrics expose scrape timestamp, active promo counts, and SKU coverage for each retailer.
- [ ] Runbook updated with retailer-specific start/stop commands, cadence notes, and troubleshooting tips.

## Tasks & Subtasks
1. **Woolworths Worker**
   - Implement TypeScript Playwright script to extract base price + WRewards pricing and multibuy badges.
   - Normalize private label brands using dictionary; ensure `promo_type` and `promo_end` captured.
2. **Makro Worker**
   - Parse bulk pack strings (e.g., `6 x 2L`) into base units; capture mCard pricing and badge text.
   - Incorporate logic for variable cadence (increase when promo detected).
3. **Food Lover's Worker**
   - Handle per-weight pricing (price per kg) and regional store variations.
   - Set `price_mode='per_weight'`, store `price_per_uom`, default quantity config.
4. **Workflow & Queue Integration**
   - Add Temporal workflows/schedules for each retailer with appropriate cadence windows.
   - Extend NestJS consumer mapping logic for bulk/per-weight cases.
   - Update automated tests covering new normalization rules.
5. **Data Validation**
   - Run initial scrapes; verify SKU counts and field completeness.
   - Spot-check 10 items per retailer for accuracy.
6. **Monitoring & Documentation**
   - Add metrics for promo counts, per-weight items, bulk packs.
   - Update runbook with retailer-specific commands and known gotchas.

## Implementation Notes
- Reuse regex and helper utilities from CPR blueprint for bulk/per-weight handling.
- Manage loyalty/promo secrets via BetterAuth/Supabase secrets; avoid logging sensitive tokens.
- Consider running Food Lover's workflows in limited store subset initially to gauge variability.

## Testing & Validation
- Automated: Jest tests for pack parsing, per-weight conversions, promo mapping.
- Manual: Temporalite UI verification; Prisma queries for sample SKUs.
- Performance: ensure each workflow finishes within window (<15 minutes for Makro bulk runs).

## Dependencies
- Stories 1.1 and 1.2 completed (queue, Temporalite, other retailers ready).

## QA Checklist
- [ ] Temporalite logs/screenshots for each retailer.
- [ ] Prisma query outputs verifying field accuracy (bulk/per-weight).
- [ ] Runbook updated with new sections.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
