# Story 1.3: Woolworths, Makro, and Food Lover's Ingestion

## Status
Draft

## Story
**As a** TillLess ingestion engineer,
**I want** Woolworths, Makro, and Food Lover's Market pipelines running on the shared Temporalite → pg-boss → NestJS stack,
**so that** the canonical product registry captures loyalty, bulk, and per-weight pricing across all priority retailers.

## Acceptance Criteria
1. Woolworths Playwright worker captures WRewards loyalty pricing, multibuy badges, and availability while respecting rate limits and emits payloads matching the ingestion contract. [Source: docs/retailer-scraping-playbook.md#24-woolworths-wrewards]
2. Makro Playwright worker parses bulk pack strings (e.g., `6 x 2L`), records mCard pricing, and generates content hashes to avoid duplicate writes. [Source: docs/retailer-scraping-playbook.md#25-makro-mcard--mrewards]
3. Food Lover's worker outputs per-weight pricing (`price_mode='per_weight'`, `price_per_uom`, `uom`) and availability cues for regional stores. [Source: docs/retailer-scraping-playbook.md#26-food-lovers-market-phase-15]
4. Temporalite workflows schedule all three retailers according to the cadence grid (WRewards sweep 60–90m, Makro bulk 6–12h with promo 90m, Food Lover's produce 2–4h) with retry policies and GitHub cron fallback. [Source: docs/retailer-scraping-playbook.md#3-scheduling-grid-ops-ready][Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
5. pg-boss consumer persists ≥300 active SKUs per retailer with loyalty/promo/bulk/per-weight fields mapped into CPR tables and duplicate suppression maintaining ≤5% delta on reruns. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused][Source: docs/canonical-product-registry.md#4-matching--normalisation-rules-addenda]
6. Monitoring dashboards/logs track scrape timestamps, SKU counts, promo/bulk/per-weight metrics per retailer, and runbooks document start/stop commands plus troubleshooting steps. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting][Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]

## Tasks / Subtasks
- [ ] Implement Woolworths ingestion worker (AC: 1)
  - [ ] Create Playwright worker under `packages/ingestion-workers/woolworths/` capturing WRewards toggles, promo badges, and availability mapping with shared helpers from `packages/ingestion-shared/`. [Source: docs/retailer-scraping-playbook.md#24-woolworths-wrewards][Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Register Temporal activities and export payload contracts via `packages/types/ingestion.ts`. [Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
- [ ] Implement Makro ingestion worker (AC: 2)
  - [ ] Build worker in `packages/ingestion-workers/makro/` parsing bulk pack strings and mCard pricing using regex outlined in CPR rules. [Source: docs/retailer-scraping-playbook.md#25-makro-mcard--mrewards][Source: docs/canonical-product-registry.md#4-matching--normalisation-rules-addenda]
  - [ ] Increase polling cadence during active promos per scheduling grid and emit content hashes for duplication control. [Source: docs/retailer-scraping-playbook.md#25-makro-mcard--mrewards]
- [ ] Implement Food Lover's ingestion worker (AC: 3)
  - [ ] Place worker under `packages/ingestion-workers/foodlovers/` capturing per-weight pricing (`price_per_uom`, `uom`) and regional availability. [Source: docs/retailer-scraping-playbook.md#26-food-lovers-market-phase-15][Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Default per-weight quantities per CPR conventions and ensure payload uses canonical units. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- [ ] Configure Temporalite schedules (AC: 4)
  - [ ] Define workflows and task queues for each retailer with cadence/ retry/backoff policies and GitHub Actions cron backup jobs. [Source: docs/retailer-scraping-playbook.md#3-scheduling-grid-ops-ready]
  - [ ] Document schedule identifiers in runbook after verifying via Temporalite UI. [Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
- [ ] Extend pg-boss consumer & Prisma mapping (AC: 5)
  - [ ] Add queue topics for the new retailers within `packages/queue-consumers/`, mapping bulk/per-weight fields into CPR tables and reusing shared validation logic. [Source: docs/architecture/source-tree.md#source-tree--module-layout][Source: docs/architecture/04-4-component-breakdown.md#43-canonical-product-registry-cpr]
  - [ ] Expand automated tests for bulk parsing, per-weight persistence, and duplicate suppression leveraging `content_hash`. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- [ ] Validate dataset & observability (AC: 5, 6)
  - [ ] Run initial scrapes to achieve ≥300 SKUs per retailer, confirm ≤5% delta on reruns, and log discrepancies for manual review. [Source: docs/canonical-product-registry.md#4-matching--normalisation-rules-addenda]
  - [ ] Update monitoring dashboards/alerts and `docs/ops/` runbooks with retailer-specific metrics, commands, and troubleshooting steps. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting][Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]

## Dev Notes
**Previous Story Insights**
- Stories 1.1 and 1.2 deliver Checkers/Shoprite/PnP ingestion plus shared Temporalite and pg-boss infrastructure; reuse common types, runbook format, and consumer patterns. [Source: docs/stories/1.1.data-backbone-bootstrap.md][Source: docs/stories/1.2.shoprite-pnp-ingestion.md]

**Retailer-Specific Guidance**
- Woolworths requires WRewards flag toggles, aggressive rate limiting (≤2 req/sec), and promo badge capture; map private-label brands via normalisation utilities. [Source: docs/retailer-scraping-playbook.md#24-woolworths-wrewards]
- Makro emphasises bulk packs and mCard pricing; parse pack info regex before persistence and adjust cadence when promos active. [Source: docs/retailer-scraping-playbook.md#25-makro-mcard--mrewards]
- Food Lover's focuses on per-weight produce with variable availability; default price mode to per-weight and set uom appropriately. [Source: docs/retailer-scraping-playbook.md#26-food-lovers-market-phase-15]

**Data Models & Storage**
- CPR schema supports per-weight (`price_mode`, `price_per_uom`, `unit_count`) and promo metadata; ensure migrations already applied support these inserts. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- Content hash enforcement prevents duplicate rows; queue consumer logic must skip writes when hashes unchanged. [Source: docs/canonical-product-registry.md#4-matching--normalisation-rules-addenda]

**Project Structure & Shared Code**
- Follow `docs/architecture/source-tree.md` for worker placement, shared utilities, and type exports to maintain consistent pnpm workspace layout.
- Shared helpers (auth, throttling, hash) live in `packages/ingestion-shared/`; import rather than duplicate logic.

**Observability & Ops**
- Monitoring should track SKU counts, promo/bulk/per-weight tallies, and failure cadence; alerts fire after two missed runs or stale timestamps. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
- Update ingestion runbooks under `docs/ops/` with retailer-specific commands, cadence info, and token rotation procedures. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]

**Security & Secrets**
- Store loyalty credentials (WRewards, mCard) in secrets manager; avoid logging tokens and rotate per playbook guidance. [Source: docs/retailer-scraping-playbook.md#1-shared-principles]

### Testing
- Unit tests: worker parsing fixtures (bulk packs, per-weight pricing) and queue consumer mapping; place alongside code per testing strategy. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Workflow tests: Temporal retry/backoff cases and idempotency for each retailer schedule. [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
- Manual QA: Temporalite UI verification, Prisma queries validating promo/per-weight fields, and spot-check parity with retailer sites.
- Key scenarios: bulk pack regex accuracy, per-weight conversions, loyalty promo capture, duplicate suppression, alert triggering on consecutive failures.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
