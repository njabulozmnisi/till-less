# Story 5.1: Receipt Upload Pipeline

- **Status:** Draft
- **Epic:** 5 â€“ Feedback Loop & Analytics
- **Related PRD Sections:** `docs/prd/05-5-scope-phase-1-mvp.md`, `docs/prd/07-7-detailed-requirements.md`
- **Related Architecture Sections:** `docs/architecture/05-5-key-data-flows.md`

## Story Statement
Allow users to upload receipts and record actual spend so that TillLess can compare predictions with reality and improve mappings.

## Acceptance Criteria
- [ ] Frontend flow for uploading receipt image (PNG/JPEG/PDF) with metadata (store, date, total) and manual entry of key items.
- [ ] Backend endpoint stores receipt metadata in Postgres and files in Supabase Storage with signed URL access, respecting 90-day retention.
- [ ] Receipt entries linked to optimisation runs for variance analysis.
- [ ] Security measures: file type validation, size limit (<5MB), virus scan stub.
- [ ] Tests cover upload success/failure, retention policy, and permissions.

## Tasks & Subtasks
1. **Frontend Upload UI**
   - Build modal/wizard for uploading, capturing metadata, manual totals.
2. **Backend Receipt Service**
   - Implement NestJS endpoint storing metadata, linking to user and run ID.
   - Generate signed URLs, schedule deletion after retention using cron.
3. **Storage & Security**
   - Configure Supabase Storage bucket rules; integrate ClamAV stub or placeholder check.
4. **Data Linking**
   - Update optimisation run schema to reference receipt IDs.
5. **Testing**
   - Component tests for uploader; integration tests for API/storage.

## Dependencies
- Auth/profile stories completed.
- Optimisation runs persisted (Epic 2).

## QA Checklist
- [ ] Test upload (file + metadata) evidence attached.
- [ ] Confirm retention job scheduled and documented.

## Implementation Log
| Date | Author | Notes |
| --- | --- | --- |

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |

## File Tracker
- _To be completed during implementation._
