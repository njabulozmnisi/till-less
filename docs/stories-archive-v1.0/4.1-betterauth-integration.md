# Story 4.1: BetterAuth Integration & Session Management

## Status
Draft

## Story
**As a** TillLess platform engineer,
**I want** BetterAuth integrated across the frontend and backend,
**so that** users can sign up, authenticate, and maintain secure sessions for shopping and optimisation features.

## Acceptance Criteria
1. BetterAuth service deployed with Supabase Postgres backing store, configured environment variables, and documented rotation procedures. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway][Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
2. Next.js app delivers signup/login/reset flows using BetterAuth SDK, persisting sessions client-side and handling logout/refresh gracefully. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
3. NestJS API validates BetterAuth JWTs via guard, exposes decorators for user context, and enforces role/claim-based access for protected endpoints. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
4. Refresh token rotation, session revocation, and logout flows function end-to-end with client state cleared and backend tokens invalidated. [Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
5. Automated tests (Jest + Playwright) cover auth flows, guard enforcement, and protected route access; CI pipelines include these checks. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Deploy BetterAuth service (AC: 1)
  - [ ] Configure BetterAuth container (Docker/Vercel) with Supabase Postgres, SMTP provider, password policies, and secrets managed via GitHub Actions/Supabase. [Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
  - [ ] Document environment variables, rotation cadence, and emergency disable procedures in ops docs. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
- [ ] Frontend auth flows (AC: 2, 4)
  - [ ] Build `/auth` pages under `apps/web/app/(auth)/` for signup, login, password reset, leveraging BetterAuth SDK hooks. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Persist sessions with secure cookies, handle refresh tokens, and clear state on logout; route guard protected pages. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
- [ ] Backend guards & context (AC: 3, 4)
  - [ ] Implement NestJS guard + decorator in `apps/backend/src/modules/auth/` verifying JWTs, extracting claims, and injecting user context into handlers. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Define scope constants (e.g., `preferences:write`, `lists:read`) and enforce in optimisation/list endpoints. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
- [ ] DevOps & monitoring (AC: 1, 4)
  - [ ] Add health checks, logging, and alerting for auth failures, login spikes, and token errors. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
  - [ ] Update runbooks with troubleshooting steps for auth outages and token revocation. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
- [ ] Testing & QA evidence (AC: 5)
  - [ ] Write Jest tests for guards/decorators and integration tests mocking BetterAuth endpoints; add Playwright/Cypress flows for signup/login/logout. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Provide QA artifacts: video of auth flows, screenshots of protected endpoints returning 401 unauthenticated.

## Dev Notes
**Dependencies & Context**
- Requires Supabase Postgres, SMTP provider (Resend), and coordination with infrastructure for secrets. Auth flows gate access to shopping list, preferences, and optimisation endpoints.

**Security Considerations**
- Enforce strong password policy, lockout attempts, CSRF protection for session cookies, secure SameSite attributes. Log suspicious activity.
- Ensure refresh tokens stored HttpOnly; implement token rotation per login and revoke on logout.

**Frontend Integration**
- Use BetterAuth React hooks for session, guard server components via middleware redirect if unauthenticated.
- Provide error messaging for incorrect credentials, account lock, unverified email, etc.

**Backend Integration**
- Adopt NestJS `ExecutionContext` to share `user` object; support role expansion for future admin features.

**Observability**
- Capture metrics (login success/failure, token refresh counts) feeding monitoring dashboards to detect anomalies.

### Testing
- Unit tests: guard verifies JWT, decorator returns context, refresh rotation logic. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration/E2E: Playwright flows for signup/login/logout, verifying protected route access and token revocation.
- Manual QA: run through registration, email verification (if enabled), auth flows on desktop/mobile, confirm protected API returns 401 when session missing.
- Key scenarios: new signup, login with existing user, password reset, refresh token expiry, revoked session, invalid token.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
