# Story 3.4: Plan Export & Sharing

## Status
Draft

## Story
**As a** TillLess shopper,
**I want** to export and share my optimisation plan as PDF or email,
**so that** I can take the recommendations into store or share them with my household.

## Acceptance Criteria
1. PDF export includes summary card, item comparison table, explanations, and assumptions formatted for print/mobile with brand styling. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
2. Email share option sends authenticated request to backend to deliver PDF link to specified address, handling success/failure messaging. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
3. Export actions emit analytics events (type, timestamp, list size) for usage tracking. [Source: docs/prd/10-10-analytics-telemetry.md#10-analytics-telemetry]
4. UI surfaces progress/ retry states for PDF generation and email delivery, maintaining accessibility and responsive layout. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
5. Jest/React Testing Library plus integration tests cover export triggers, API hooks, and analytics emission; sample PDFs/E2E email verification captured for QA. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Export service integration (AC: 1, 2)
  - [ ] Implement API route or backend call (`/exports/plan`) that generates PDF using shared components (React PDF or server-side rendering) under `apps/web/app/api/exports/plan/`. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Ensure BetterAuth token included, handle rate limits, and return signed URL for download. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
- [ ] UI controls & feedback (AC: 1, 2, 4)
  - [ ] Add export/share buttons to results page, providing progress spinners, toast notifications, and retry options. [Source: docs/stories/3.3-optimisation-results-ui.md]
  - [ ] Support mobile friendly layout and accessible announcements for completion/errors. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
- [ ] Email delivery (AC: 2)
  - [ ] Integrate transactional email provider (Resend or SES) via backend endpoint, sending templated email with link and summary. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
  - [ ] Validate email addresses client-side and server-side; support localization of subject/body text.
- [ ] Analytics instrumentation (AC: 3)
  - [ ] Emit analytics events (`plan_export`, `plan_email`) with metadata (list size, loyalty toggles) via analytics SDK. [Source: docs/prd/10-10-analytics-telemetry.md#10-analytics-telemetry]
  - [ ] Document schema in analytics tracking plan.
- [ ] Testing & QA artifacts (AC: 5)
  - [ ] Add unit/component tests for control states, API hooks, analytics emission; create integration test verifying PDF generation pipeline. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Provide sample PDF and email screenshot in QA evidence folder.

## Dev Notes
**Dependencies & Context**
- Depends on results UI (Story 3.3) for data, backend export/email endpoints (to be coordinated with Epic 2/4 teams). Confirm content contract for PDF sections.

**PDF Generation**
- Use server-side rendering (Next.js route handler or backend service) to ensure consistent output; include fallback font bundling for offline access.
- Provide print-friendly styling, compress images, and ensure file size <5 MB.

**Email Workflow**
- Use double-submit prevention (disable button while pending). Ensure backend logs include correlation ID for troubleshooting.

**Security & Access**
- Signed URLs should expire (e.g., 24 hours). Validate recipient email domain if required. Store minimal export metadata per security guidance.

**Analytics**
- Align event names with analytics schema to track funnel; capture success/failure to monitor adoption. [Source: docs/prd/10-10-analytics-telemetry.md#10-analytics-telemetry]

### Testing
- Unit/component tests: button states, validation, toast messaging, analytics event emission. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: mock backend export/email endpoints verifying PDF link flow and error handling.
- Manual QA: generate sample PDF, send email to test inbox, verify accessible announcements, ensure responsive layout.
- Key scenarios: successful export, backend failure with retry, invalid email input, offline mode, analytics event missing.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
