# Story 2.1: Optimisation Service Foundation

## Status
Draft

## Story
**As a** TillLess backend engineer,
**I want** the NestJS optimisation API scaffolded with Prisma integration and request validation,
**so that** shopping list submissions can retrieve canonical product data and return structured baseline responses for later optimisation logic.

## Acceptance Criteria
1. Optimisation module lives within the backend NestJS app (`apps/backend/`) exposing REST endpoint(s) for shopping list optimisation with controller, service, DTOs, and OpenAPI documentation. [Source: docs/architecture/source-tree.md#source-tree--module-layout][Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
2. Prisma schema and data-access layer expose queries over canonical products, price snapshots, and store metadata to support optimisation inputs. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused][Source: docs/architecture/04-4-component-breakdown.md#43-canonical-product-registry-cpr]
3. Endpoint validates shopping list payloads (items, quantity, unit, substitution tolerance, must-have flag) using class-validator pipes and returns well-typed error responses when validation fails. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
4. Service pulls CPR data via Prisma and returns structured placeholder result including request echo, canonical matches, and stubbed pricing totals ready for future optimisation logic. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
5. Jest unit/integration tests cover DTO validation, service queries (using Prisma test environment), and ensure performance budget readiness (target <30s for ≤60 items). [Source: docs/architecture/testing-strategy.md#testing-strategy][Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
6. API documented in Swagger/OpenAPI with example requests/responses and README/API notes updated for frontend consumers. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]

## Tasks / Subtasks
- [ ] Bootstrap optimisation module inside NestJS backend (AC: 1)
  - [ ] Generate module/controller/service/DTO structure under `apps/backend/src/modules/optimisation/` with dependency injection ready for future subcomponents. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Register routes within existing backend app and ensure OpenAPI decorators expose endpoint at `/api/optimisation`. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
- [ ] Extend Prisma schema & data-access (AC: 2)
  - [ ] Update `packages/data-access/prisma/schema.prisma` to include views/relations for canonical products, retailer items, price snapshots, and store metadata required for optimisation. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
  - [ ] Regenerate Prisma client, create migration, and expose typed repository helpers in `packages/data-access/src/optimisation.repository.ts`. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
- [ ] Implement DTOs and validation pipeline (AC: 3)
  - [ ] Define request/response DTOs with class-validator decorators enforcing recognised units, substitution tolerances, and must-have flag defaults. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
  - [ ] Configure global validation pipe / exception filters to return consistent error payloads documented in OpenAPI. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
- [ ] Build baseline service logic (AC: 4)
  - [ ] Query CPR tables via Prisma to fetch candidate products, latest price snapshots, promo metadata, and store data based on shopping list inputs. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
  - [ ] Return structured response containing request echo, canonical matches, unresolved item list, and placeholder totals (set to null with TODO notes) for later algorithm stories. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- [ ] Testing & docs (AC: 5, 6)
  - [ ] Write Jest unit tests for DTO validation and service logic (mocked Prisma) plus integration test using Prisma test environment and seeded CPR fixtures. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Publish Swagger docs with example payload/response and update backend README/API guide for frontend integration steps. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]

## Dev Notes
**Previous Story Insights**
- Epic 1 stories populated CPR data and established ingestion pipelines; rely on those schemas and shared TypeScript types when querying canonical data. [Source: docs/stories/1.1.data-backbone-bootstrap.md][Source: docs/stories/1.2.shoprite-pnp-ingestion.md][Source: docs/stories/1.3-woolworths-makro-foodlovers.md]

**Architecture Guidance**
- Backend optimisation service resides in the NestJS app with modules structured for REST/GraphQL endpoints and Prisma data access. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
- Optimisation request flow pulls latest price snapshots, computes totals, and returns results to frontend; this story sets up data retrieval layer ahead of full optimisation logic. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
- Maintain separation of concerns: controllers handle validation, services orchestrate data fetch, and later stories will add algorithmic calculations and travel cost heuristics.

**Data & Persistence**
- CPR schema includes loyalty prices, promo metadata, per-weight handling; queries should join relevant tables while enforcing availability filters. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- Use `packages/data-access/` for Prisma client wrappers so multiple modules can reuse them. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

**Non-Functional Requirements**
- Optimisation API must respond within 30 seconds for ≤60 items; structure queries with pagination/batching and prepare to add caching in future stories. [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
- Observability metrics should emit latency, error rates, and savings variance when available; integrate instrumentation hooks during implementation. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

**Security & Auth**
- Integrate BetterAuth guards (from Epic 4) once available; for now, ensure endpoints support injecting session context, but do not expose sensitive data. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]

### Testing
- Unit tests: DTO validation, service queries with mocked Prisma, repository helpers. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: use Prisma test environment seeded with CPR fixture data to validate canonical fetches and response structure. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Manual QA: verify Swagger/OpenAPI docs, test endpoint via REST client with sample list, ensure validation errors return meaningful messages.
- Key scenarios: valid payload returns matches, missing required fields trigger validation errors, unknown units produce validation failure, CPR query returns empty results flagged in response, integration test ensures latency within expectation.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
