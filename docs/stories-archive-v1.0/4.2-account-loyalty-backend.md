# Story 4.2: Account Profile & Loyalty Backend

## Status
Draft

## Story
**As a** TillLess backend engineer,
**I want** secure profile and loyalty storage with preference APIs,
**so that** the frontend and optimisation engine can honour user-specific constraints.

## Acceptance Criteria
1. Prisma models/migrations add `UserProfile`, `LoyaltyCard`, and preference fields (max stores, max distance, value-of-time, substitution defaults) with encryption at rest for sensitive data. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused][Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
2. NestJS exposes `GET/PUT /profile` and `GET/PUT /preferences` endpoints secured by BetterAuth guard and returning DTOs aligned with frontend needs. [Source: docs/stories/4.1-betterauth-integration.md]
3. Loyalty card numbers hashed/encrypted before persistence; secrets stored in vault/secrets manager with rotation guidance. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
4. API documented via Swagger/OpenAPI with request/response schemas and error handling notes. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
5. Automated tests cover service logic, encryption utilities, and controller behaviour (unit + integration with Prisma test DB). [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Schema & migrations (AC: 1)
  - [ ] Extend `packages/data-access/prisma/schema.prisma` with profile/loyalty models, encryption fields, and relations; generate migration scripts. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Update seeds/fixtures for tests and document new schema in `db/README.md`. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- [ ] Services & encryption (AC: 1, 3)
  - [ ] Implement profile and preferences services in `apps/backend/src/modules/profile/` using Prisma repositories and encryption helpers (e.g., libsodium). [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
  - [ ] Configure secrets (encryption keys) via environment variables stored in Supabase/Actions secrets; document rotation.
- [ ] Controllers & DTOs (AC: 2, 4)
  - [ ] Create DTOs with class-validator ensuring range checks (max stores 1â€“3, distance bounds, etc.) and map to service layer. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
  - [ ] Register endpoints with BetterAuth guard/decorators from Story 4.1, updating Swagger with examples. [Source: docs/stories/4.1-betterauth-integration.md]
- [ ] Integration with frontend (AC: 2, 4)
  - [ ] Provide typed SDK or client wrapper for Story 3.2; document contract in README and share sample payloads. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
- [ ] Testing & QA (AC: 5)
  - [ ] Write Jest unit tests for services/encryption, integration tests using Prisma test DB verifying persistence and decryption, plus Supertest e2e for guards. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Capture evidence of encrypted loyalty data (DB snapshot) and Swagger screenshots for QA.

## Dev Notes
**Dependencies & Context**
- Depends on BetterAuth integration (Story 4.1) to supply user context/claims. Frontend Story 3.2 relies on these endpoints for preference management.

**Security**
- Hash loyalty numbers with salted hashing + encrypt raw values separately if retrieval needed. Follow principle of least privilege for DB roles.
- Audit logging for preference updates and loyalty changes; integrate with monitoring.

**Data Model**
- Store value-of-time as integer cents, distances in km, substitution defaults as enumerations. Provide defaults for new users.

**Monitoring**
- Emit metrics for profile updates, loyalty toggles, and error counts. Add alerts for encryption failures.

### Testing
- Unit tests: encryption helper, DTO validation, service mapping. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: create/update profile and preferences, verify hashed/encrypted storage, guard enforcement. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Manual QA: use Swagger/Postman to create profile, inspect DB for hashed values, confirm unauthenticated requests blocked.
- Key scenarios: new profile creation, loyalty update, invalid value-of-time range, unauthorized access, secret rotation simulation.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
