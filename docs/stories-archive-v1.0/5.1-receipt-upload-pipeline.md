# Story 5.1: Receipt Upload Pipeline

## Status
Draft

## Story
**As a** TillLess shopper,
**I want** to upload receipts and record actual spend,
**so that** TillLess can compare predictions with reality and improve product mappings.

## Acceptance Criteria
1. Frontend upload flow accepts PNG/JPEG/PDF receipts up to 5 MB, captures metadata (store, date, total, notes), and supports manual entry of key items. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
2. Backend endpoint stores receipt metadata in Supabase Postgres, files in Supabase Storage with signed URLs, and links receipts to optimisation runs for variance analysis. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
3. Security measures enforce file type validation, size limits, anti-virus stub, and 90-day retention deletion job. [Source: docs/prd/07-7-detailed-requirements.md#72-non-functional-requirements]
4. Uploaded receipts surface in analytics data model for accuracy tracking, emitting events for later dashboards. [Source: docs/prd/10-10-analytics-telemetry.md#10-analytics-telemetry]
5. Automated tests validate upload success/failure, retention scheduling, permission checks, and metadata linkage. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Frontend upload experience (AC: 1)
  - [ ] Build upload modal/wizard under `apps/web/app/(authenticated)/receipts/` with drag-drop, metadata form, preview, and manual total entry. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Validate file type/size client-side, display progress, and handle error states accessibly. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
- [ ] Backend receipt service (AC: 2, 3)
  - [ ] Implement NestJS controller/service in `apps/backend/src/modules/receipts/` handling metadata persistence, signed URL generation, and user association. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
  - [ ] Schedule retention job (Temporal/GitHub cron) to delete files older than 90 days and log actions. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
- [ ] Storage & security hardening (AC: 3)
  - [ ] Configure Supabase Storage bucket policies, integrate ClamAV (or placeholder) scan pipeline, and ensure signed URLs expire. [Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
  - [ ] Encrypt sensitive metadata where necessary and audit log access.
- [ ] Data linkage & analytics (AC: 2, 4)
  - [ ] Update optimisation run schema to reference receipts, record variance metrics, and emit analytics events (`receipt_uploaded`, `variance_recorded`). [Source: docs/prd/10-10-analytics-telemetry.md#10-analytics-telemetry]
  - [ ] Provide API endpoint to list receipts per run for future dashboards.
- [ ] Testing & QA artifacts (AC: 5)
  - [ ] Add React Testing Library component tests for uploader, Jest integration tests with mocked storage, and Supertest e2e verifying auth/permissions. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Supply QA evidence: sample upload, metadata record, retention job logs.

## Dev Notes
**Dependencies**
- Requires BetterAuth-protected endpoints (Story 4.1) and optimisation run persistence (Stories 2.1â€“2.3). Frontend integration will reuse auth context and analytics SDK.

**File Handling**
- Stream uploads directly to Supabase using signed URLs; track upload status for progress UI. Enforce MIME whitelist.

**Retention & Compliance**
- 90-day retention per PRD; document schedule, deletion logs, and manual override steps.

**Analytics**
- Capture variance (predicted vs actual total) to feed savings dashboard (Story 5.2).

### Testing
- Unit/component tests: uploader validations, metadata form, API service logic. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: upload path end-to-end with mock storage, verify retention job removes old files.
- Manual QA: upload sample receipt, confirm retrieval, verify deletion after forced retention run, inspect analytics event.
- Key scenarios: invalid file type, oversized file, storage failure, unauthorized access, retention job skipping active disputes.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
