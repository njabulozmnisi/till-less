# Story 3.2: Preferences & Loyalty Management UI

## Status
Draft

## Story
**As a** TillLess shopper,
**I want** to manage loyalty cards, effort tolerance, and travel preferences in one dashboard,
**so that** optimisation runs reflect my personal constraints and value-of-time.

## Acceptance Criteria
1. Authenticated preferences page loads current settings (loyalty card toggles, max stores, max distance, value-of-time) with BetterAuth-protected API calls and reset-to-default option. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements][Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
2. Form inputs validate ranges (max stores 1–3, distance km bounds, value-of-time numeric) with helper text and accessible error messaging. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
3. Updates persist via backend preferences endpoints (PATCH/GET), using optimistic UI updates and rollback on failure. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
4. Loyalty card toggles cover Checkers, Pick n Pay, Shoprite, Woolworths, and Makro; state reflects session context during load. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
5. Jest + React Testing Library coverage validates form interactions, API success/failure handling, and default reset behaviour. [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] Build preferences UI components (AC: 1, 2, 4)
  - [ ] Create loyalty toggle list, numeric inputs, and helper text using design system components under `apps/web/app/(authenticated)/preferences/`. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Provide accessible labels, descriptions, and inline validation messages for each field. [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]
- [ ] Data fetching & persistence (AC: 1, 3)
  - [ ] Implement React Query hooks for `GET /preferences` and `PATCH /preferences`, seeding form state on load and syncing optimistic updates. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
  - [ ] Handle BetterAuth session tokens via existing auth context, refreshing if expired. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
- [ ] Error handling & UX polish (AC: 2, 3)
  - [ ] Surface toast notifications for success/failure, show inline rollback messaging, and expose retry button when network fails. [Source: docs/prd/08-8-user-journeys.md#8-user-journeys]
  - [ ] Add reset-to-default action confirming with modal before applying defaults. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- [ ] Testing & documentation (AC: 5)
  - [ ] Write React Testing Library suites covering load state, toggle changes, validation errors, optimistic rollback, and reset flow. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Update `apps/web/README.md` and user guide with screenshots/instructions and note dependency on BetterAuth scopes. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

## Dev Notes
**Context**
- Preferences feed optimisation scoring (Stories 2.2 and 2.3). Ensure API contract aligns with backend DTOs for value-of-time and store limits. [Source: docs/stories/2.2-promo-pricing-engine.md][Source: docs/stories/2.3-travel-costs-explanations.md]

**Authentication**
- BetterAuth SDK provides loyalty claims and profile data; include error handling for expired sessions (prompt re-auth). [Source: docs/architecture/04-4-component-breakdown.md#46-frontend-web-application]

**Validation Rules**
- Value-of-time expressed in R/hour; clamp to business-approved range (e.g., R0–R500). Max distance default 15 km, max stores default 1 (per MVP). [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]

**Accessibility**
- Toggle list should work with keyboard (space/enter) and screen readers announcing state. Provide context text describing impact on optimisation.

**State Management**
- Co-locate form state with React Hook Form or controller pattern, storing derived summary for preview (e.g., “You’ll travel up to 10 km”).

### Testing
- Unit/component tests: form rendering, toggles, validation boundaries, optimistic updates with mocked API. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: combined preference hook + API mock verifying persistence semantics.
- Manual QA: capture video showing initial load, editing values, reset defaults, error retry, and verifying persistence after reload.
- Key scenarios: toggling all loyalty cards, invalid numeric input, network failure rollback, session expiry requiring re-auth, defaults restore.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
