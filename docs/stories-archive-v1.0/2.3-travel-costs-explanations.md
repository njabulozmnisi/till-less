# Story 2.3: Travel Costs & Explanation Engine

## Status
Draft

## Story
**As a** TillLess optimisation engineer,
**I want** travel/time cost modelling and human-readable explanations integrated into the optimisation results,
**so that** users understand price vs. effort trade-offs when choosing the recommended store.

## Acceptance Criteria
1. Travel cost heuristics compute effort scores using distance × value-of-time with configurable rate tables and optional OSRM distance lookups. [Source: docs/architecture/04-4-component-breakdown.md#44-optimisation-service][Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
2. Optimisation respects user preferences (max stores, value-of-time, effort tolerance) when scoring recommendations and filtering results. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
3. API response includes `assumptions` and `explanations` sections detailing travel inputs, effort scores, and rationale for top recommendation vs runner-up. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
4. Explanation generator summarises key drivers (savings, travel, missing items, promos) in concise, user-friendly text suitable for UI display (<200 characters each). [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
5. Automated tests cover travel scenarios (local vs distant store, varying value-of-time, multi-store tolerance) and explanation content accuracy. [Source: docs/architecture/testing-strategy.md#testing-strategy]
6. Observability metrics/logs capture travel cost inputs, explanation counts, and fallback scenarios for monitoring. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

## Tasks / Subtasks
- [ ] Travel heuristics module (AC: 1, 2)
  - [ ] Implement service under `apps/backend/src/modules/optimisation/travel/` that calculates travel effort using configurable rate table (value-of-time × distance) with optional OSRM integration behind a feature flag. [Source: docs/architecture/source-tree.md#source-tree--module-layout][Source: docs/architecture/11-11-open-technical-questions.md#11-open-technical-questions]
  - [ ] Cache/store distance lookups (e.g., Supabase table) to avoid redundant API calls and support unit tests. [Source: docs/architecture/04-4-component-breakdown.md#44-optimisation-service]
- [ ] Integrate travel cost into optimisation scoring (AC: 1, 2)
  - [ ] Update optimisation service to combine pricing totals with travel effort when ranking recommendations, honouring max-store and effort tolerance constraints. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
  - [ ] Adjust response model to include travel cost fields and overall effort score for each retailer evaluated. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
- [ ] Explanation engine (AC: 3, 4)
  - [ ] Create explanation formatter utility generating concise messages for winner, runner-up, and key trade-offs (price savings, travel cost, missing items, promos). [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
  - [ ] Populate response `assumptions` (inputs used) and `explanations` arrays (message + supporting data). [Source: docs/prd/08-8-user-journeys.md#8-user-journeys]
- [ ] Testing & observability (AC: 5, 6)
  - [ ] Add Jest tests covering distance lookup caching, effort computation, explanation formatting, and integration tests verifying recommendation changes under different preferences. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Emit metrics/logs for travel inputs, explanation generation, and fallback paths (e.g., missing distance data) to feed monitoring dashboards. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

## Dev Notes
**Context**
- Builds on Stories 2.1 and 2.2; extend optimisation service to incorporate travel heuristics alongside promo pricing results. [Source: docs/stories/2.1-optimisation-service-foundation.md][Source: docs/stories/2.2-promo-pricing-engine.md]
- User preferences include value-of-time, max stores, and effort tolerance; ensure request DTOs capture these inputs (or fetch from BetterAuth profile) before scoring. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]

**Travel Data**
- Distance sources: start with configurable static matrix or rate table; feature flag OSRM integration for future upgrade. Document chosen approach in runbooks. [Source: docs/architecture/11-11-open-technical-questions.md#11-open-technical-questions]
- Cache results keyed by origin/destination to control cost; consider TTL for stale data.

**Scoring & Explanations**
- Overall recommendation score = pricing totals + travel effort penalty; ensure trade-offs transparent to user via `explanations` messages normalized for UI. [Source: docs/architecture/05-5-key-data-flows.md#52-optimisation-request-flow]
- Include reason codes for missing items or preference violations to help UI highlight limitations.

**Performance & Monitoring**
- Travel computation must keep total optimisation runtime ≤30 seconds; batch distance lookups and reuse cached results. [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
- Emit metrics for travel cost usage, explanation count, fallback rate (static vs OSRM) for monitoring dashboards. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

**Project Structure**
- Travel utilities belong in `apps/backend/src/modules/optimisation/travel/`; explanation formatter can live under `apps/backend/src/modules/optimisation/explanations/` with shared types in `packages/types/optimisation.ts`. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

### Testing
- Unit tests: travel cost calculator with different rate tables, OSRM flag toggle, explanation messages for varied scenarios. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: seeded CPR and distance data verifying recommendation order changes with value-of-time adjustments. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Manual QA: call API via Swagger/Postman to confirm assumptions/explanations sections and travel adjustments in summary.
- Key scenarios: local store vs distant store cost comparison, high vs low value-of-time, exceeding max stores (should remain 1), missing distance fallback, explanation localization length check.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
