# Story 2.2: Promotion & Pricing Engine

## Status
Draft

## Story
**As a** TillLess optimisation engineer,
**I want** the optimisation service to compute basket totals with promos, loyalty pricing, and substitution logic,
**so that** savings estimates and per-item breakdowns reflect real retailer offers for the user’s shopping list.

## Acceptance Criteria
1. Pricing engine applies base price, loyalty price, and promotion logic (multibuy, combo, loyalty markdown, bulk deals) according to CPR promo metadata and user-selected loyalty cards. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused][Source: docs/retailer-scraping-playbook.md#21-checkers--sixty60]
2. Substitution logic respects user tolerances (brand lock, size variance, must-have flag) and marks unmet items with reason codes. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
3. Response payload includes per-item breakdown (selected store, price, applied promos, savings vs. baseline) plus aggregate totals (basket price, savings %, promo summary). [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
4. Unit price calculations handle pack conversions (`price_mode`, `price_per_uom`, `unit_count`) ensuring consistent comparisons across retailers. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
5. Automated tests cover loyalty-only, multibuy, combo, bulk pack, per-weight scenarios, substitution edge cases, and insufficient quantity thresholds. [Source: docs/architecture/testing-strategy.md#testing-strategy]
6. Observability captures pricing engine metrics (promo usage, savings variance, errors) for dashboards/alerts. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

## Tasks / Subtasks
- [ ] Build pricing utilities (AC: 1, 4)
  - [ ] Implement helper functions under `apps/backend/src/modules/optimisation/pricing/` for unit conversions, loyalty selection, multibuy/combo evaluation, and effective price computation. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Ensure utilities support precision math (mathjs or custom) to avoid floating-point drift. [Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
- [ ] Implement promotion engine (AC: 1, 3)
  - [ ] Evaluate promo eligibility per item (quantity thresholds, promo window) using CPR metadata (`promo_type`, `promo_start`, `promo_end`, `promo_badge_raw`). [Source: docs/canonical-product-registry.md#4-matching--normalisation-rules-addenda]
  - [ ] Produce promo explanation objects for response payload and aggregate savings counters. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- [ ] Enhance substitution & matching logic (AC: 2)
  - [ ] Extend matching service to evaluate brand locks, allowed size variance, substitution tolerance, and must-have flag before selecting replacements. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]
  - [ ] Label unmet items with reason codes (e.g., `no_match`, `oversize`, `brand_restricted`) for frontend display. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- [ ] Update response formatting & API docs (AC: 3)
  - [ ] Extend DTOs to include per-item price breakdown, promo details, savings vs. baseline, and basket summary totals. [Source: docs/architecture/04-4-component-breakdown.md#45-api--backend-gateway]
  - [ ] Update Swagger/OpenAPI documentation with examples for each promo/substitution scenario. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- [ ] Testing & observability (AC: 5, 6)
  - [ ] Write Jest suites covering promo combinations, loyalty toggles, bulk packs, per-weight pricing, and substitution edge cases using fixtures in `packages/data-access/test/fixtures/`. [Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [ ] Add metrics/structured logs for promo decisions, savings variance, and substitution failures to feed dashboards/alerts. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

## Dev Notes
**Dependencies & Context**
- Builds on Story 2.1’s optimisation module; reuse DTOs, repositories, and response structures already defined. [Source: docs/stories/2.1-optimisation-service-foundation.md]
- CPR data includes promo metadata, loyalty prices, and per-weight info from Epic 1 ingestion stories; rely on these fields for pricing decisions. [Source: docs/stories/1.1.data-backbone-bootstrap.md]

**Pricing & Promo Details**
- Promo metadata includes types (`multibuy`, `combo`, `loyalty`, `markdown`, `bulk_deal`), start/end dates, and raw badge text; implement logic to prioritise best effective price for the user. [Source: docs/canonical-product-registry.md#3-field-reference-delta-focused]
- Loyalty pricing depends on user’s active cards (BetterAuth session to provide card toggles). Ensure module accepts loyalty context from request payload/session. [Source: docs/prd/07-7-detailed-requirements.md#71-functional-requirements]

**Substitution Logic**
- Users define substitution tolerance (brand lock vs. allowed alternatives) and size variance; algorithm should rank candidates accordingly and note fallbacks. [Source: docs/prd/05-5-scope-phase-1-mvp.md#51-in-scope]
- Must-have items should prevent substitution; if no match, mark as unmet to highlight risk.

**Performance & Observability**
- Optimisation remains subject to ≤30s response time; ensure promo calculations are efficient (batch computations, caching). [Source: docs/architecture/07-7-non-functional-considerations.md#7-non-functional-considerations]
- Emit metrics for promo application counts, savings variance, substitution failures; integrate with monitoring story 1.4 deliverables. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

**Project Structure**
- Follow `apps/backend/src/modules/optimisation/` structure for pricing/substitution services; share reusable utilities via `packages/types/` and `packages/data-access/`. [Source: docs/architecture/source-tree.md#source-tree--module-layout]

### Testing
- Unit tests: pricing utilities, promo eligibility evaluators, substitution selectors. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Integration tests: seeded CPR fixtures verifying final basket totals and substitution outcomes. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Manual QA: send sample shopping lists through Swagger/Postman to confirm promos, savings, and substitution messages render correctly.
- Key scenarios: loyalty-only discount, multibuy threshold met/unmet, combo promos requiring cross-item matching, bulk pack conversions, per-weight pricing, substitution failure due to brand lock, savings variance metric captured.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
