# Story 6.1: CI/CD & Deployment Automation

## Status
Draft

## Story
**As a** TillLess DevOps engineer,
**I want** automated build, test, and deployment pipelines,
**so that** releases across backend, frontend, and Temporalite remain consistent and reliable.

## Acceptance Criteria
1. GitHub Actions pipeline runs lint, unit/integration tests, and Prisma migrations on pull requests using Node 20 + pnpm caching. [Source: docs/architecture/06-6-technology-stack.md#6-technology-stack]
2. Successful merges deploy backend (Render), frontend (Vercel), and Temporalite services to staging with environment-specific configuration. [Source: docs/architecture/08-8-deployment-environments.md#8-deployment-environments]
3. Temporalite workflow definitions packaged and deployed via CI (Docker image or pnpm script) ensuring orchestration stays in sync. [Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
4. Secrets managed via GitHub Actions secrets and environment stores (Render/Vercel/Supabase) with documented rotation procedures. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
5. Pipeline status badges added to README and deployments emit monitoring events/logs for auditability. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]
6. Automated tests/QA include CI run artifacts and staging verification (health checks, smoke tests). [Source: docs/architecture/testing-strategy.md#testing-strategy]

## Tasks / Subtasks
- [ ] CI workflow configuration (AC: 1)
  - [ ] Create `.github/workflows/ci.yml` running lint (`pnpm lint`), unit tests, integration tests, and Prisma migrations with pnpm caching. [Source: docs/architecture/source-tree.md#source-tree--module-layout]
  - [ ] Upload coverage/test artifacts for review.
- [ ] Deployment automation (AC: 2)
  - [ ] Add GitHub Actions job deploying backend (Render CLI/API) and frontend (Vercel CLI) with environment promotion rules. [Source: docs/architecture/08-8-deployment-environments.md#8-deployment-environments]
  - [ ] Implement post-deploy smoke tests hitting health endpoints.
- [ ] Temporalite release process (AC: 3)
  - [ ] Build/publish Temporalite workflow Docker image or tarball; trigger redeploy on staging via CI step. [Source: docs/architecture/04-4-component-breakdown.md#41-data-ingestion-layer]
  - [ ] Update documentation on versioning/rollback for workflows.
- [ ] Secrets & configuration management (AC: 4)
  - [ ] Centralise secrets (BetterAuth, Supabase, storage) in GitHub Actions and environment stores; document rotation/approval steps. [Source: docs/architecture/04-4-component-breakdown.md#48-observability--ops]
  - [ ] Include automated checks ensuring required secrets present before deploy.
- [ ] Documentation & monitoring (AC: 5, 6)
  - [ ] Update `docs/ops/deployment-runbook.md` (create if absent) with pipeline overview, rollback steps, and monitoring hooks. [Source: docs/architecture/08-8-deployment-environments.md#8-deployment-environments]
  - [ ] Add README badges and configure alerts for failed deployments or CI regressions. [Source: docs/architecture/09-9-monitoring-alerting.md#9-monitoring--alerting]

## Dev Notes
**Dependencies**
- Build scripts for backend/frontend/worker should already exist; coordinate with teams to ensure `pnpm build` ready.

**Branch Strategy**
- Define staging vs production deployment triggers (e.g., `develop` → staging, `main` → prod). Document gating procedures.

**Testing Integration**
- Consider adding Playwright smoke tests post-deploy for key user journeys.

**Cost Control**
- Use caching and concurrency settings to keep Action minutes reasonable.

### Testing
- CI tests automatically executed per pipeline; include integration tests for migrations and deployment smoke tests. [Source: docs/architecture/testing-strategy.md#testing-strategy]
- Manual QA: record pipeline run and staging validation (screenshots/links).
- Key scenarios: failing tests block deploy, missing secret halts pipeline, Temporalite image update triggers restart, rollback runbook executed.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-28 | v0.1 | Initial draft prepared by Scrum Master | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
| Date | Reviewer | Outcome | Notes |
| --- | --- | --- | --- |
